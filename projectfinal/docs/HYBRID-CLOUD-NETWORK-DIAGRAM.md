# 🌐 HYBRID CLOUD NETWORK ARCHITECTURE DIAGRAM

## Sơ đồ kiến trúc mạng Hybrid Cloud với AWS Transit Gateway

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                                         │
│                                         HYBRID CLOUD ARCHITECTURE                                                                       │
│                                    (OpenStack + AWS Transit Gateway)                                                                    │
│                                                                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                                         │
│      ┌────────────────────────────────────────────────────────┐              ┌────────────────────────────────────────────────────────┐ │
│      │                                                        │              │                                                        │ │
│      │                    OPENSTACK                           │              │                       AWS                              │ │
│      │                 (On-Premises DC)                       │              │              (ap-southeast-1 Singapore)                │ │
│      │                                                        │              │                                                        │ │
│      │  ┌──────────────────────────────────────────────────┐  │              │  ┌──────────────────────────────────────────────────┐  │ │
│      │  │                                                  │  │              │  │                                                  │  │ │
│      │  │              K3s Master                          │  │              │  │           K3s Worker (aws-worker-1)              │  │ │
│      │  │              10.0.1.185                          │  │              │  │                                                  │  │ │
│      │  │                                                  │  │              │  │           TKB Microservice                       │  │ │
│      │  │  ┌────────────────────────────────────────────┐  │  │              │  │           NodePort: 30080                        │  │ │
│      │  │  │ • Keycloak (OIDC)                         │  │  │              │  │           Private IP: 10.100.2.50                │  │ │
│      │  │  │ • OAuth2-Proxy                            │  │  │              │  │                                                  │  │ │
│      │  │  │ • Demo-App (FastAPI)                      │  │  │              │  │  ┌────────────────────────────────────────────┐  │  │ │
│      │  │  │ • Istio Control Plane                     │  │  │              │  │  │ • Node.js/Express API                     │  │  │ │
│      │  │  │ • SPIRE Server                            │  │  │              │  │  │ • /api/tkb endpoint                       │  │  │ │
│      │  │  │ • OPA Policy Engine                       │  │  │              │  │  │ • Role-based TKB data                     │  │  │ │
│      │  │  └────────────────────────────────────────────┘  │  │              │  │  └────────────────────────────────────────────┘  │  │ │
│      │  │                                                  │  │              │  │                                                  │  │ │
│      │  └──────────────────────────────────────────────────┘  │              │  └──────────────────────────────────────────────────┘  │ │
│      │                         │                              │              │                         │                              │ │
│      │  ┌──────────────────────────────────────────────────┐  │              │  ┌──────────────────────────────────────────────────┐  │ │
│      │  │                                                  │  │              │  │                                                  │  │ │
│      │  │              K3s Worker                          │  │              │  │          VPN Gateway Instance                    │  │ │
│      │  │              10.0.1.65                           │  │              │  │          (Customer Gateway Endpoint)             │  │ │
│      │  │                                                  │  │              │  │                                                  │  │ │
│      │  │  ┌────────────────────────────────────────────┐  │  │              │  │          Public IP: 18.143.117.69               │  │ │
│      │  │  │ • Prometheus                              │  │  │              │  │          Private IP: 10.100.1.x                 │  │ │
│      │  │  │ • Grafana                                 │  │  │              │  │                                                  │  │ │
│      │  │  │ • Loki                                    │  │  │              │  │  ┌────────────────────────────────────────────┐  │  │ │
│      │  │  │ • Workload Pods                           │  │  │              │  │  │ • IPSec VPN Termination                   │  │  │ │
│      │  │  └────────────────────────────────────────────┘  │  │              │  │  │ • BGP Routing (ASN 65000)                 │  │  │ │
│      │  │                                                  │  │              │  │  │ • Tunnel 1 & 2 (HA)                       │  │  │ │
│      │  └──────────────────────────────────────────────────┘  │              │  │  └────────────────────────────────────────────┘  │  │ │
│      │                         │                              │              │  │                                                  │  │ │
│      │                         │                              │              │  └──────────────────────────────────────────────────┘  │ │
│      │                         │                              │              │                         │                              │ │
│      │  ┌──────────────────────┴───────────────────────────┐  │              │  ┌──────────────────────┴───────────────────────────┐  │ │
│      │  │                                                  │  │              │  │                                                  │  │ │
│      │  │           ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┓          │  │              │  │               PRIVATE SUBNET                     │  │ │
│      │  │           ┃    PRIVATE-NET (Tenant)   ┃          │  │              │  │               10.100.2.0/24                      │  │ │
│      │  │           ┃       10.0.1.0/24         ┃          │  │              │  │                                                  │  │ │
│      │  │           ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━┛          │  │              │  │  Route Table:                                    │  │ │
│      │  │                        │                         │  │              │  │  • 0.0.0.0/0 → NAT Gateway                       │  │ │
│      │  │                        │                         │  │              │  │  • 172.10.0.0/24 → Transit Gateway               │  │ │
│      │  │                        │                         │  │              │  │  • 10.0.1.0/24 → Transit Gateway                 │  │ │
│      │  └────────────────────────┼─────────────────────────┘  │              │  │  • 10.42.0.0/16 → Transit Gateway                │  │ │
│      │                           │                            │              │  │                                                  │  │ │
│      │  ┌────────────────────────┼─────────────────────────┐  │              │  └──────────────────────────────────────────────────┘  │ │
│      │  │                        │                         │  │              │                         │                              │ │
│      │  │           ┌────────────┴────────────┐            │  │              │  ┌──────────────────────┴───────────────────────────┐  │ │
│      │  │           │                         │            │  │              │  │                                                  │  │ │
│      │  │           │     ╔═══════════╗       │            │  │              │  │               PUBLIC SUBNET                      │  │ │
│      │  │           │     ║    r1     ║       │            │  │              │  │               10.100.1.0/24                      │  │ │
│      │  │           │     ║  Router   ║       │            │  │              │  │                                                  │  │ │
│      │  │           │     ╚═════╤═════╝       │            │  │              │  │  Route Table:                                    │  │ │
│      │  │           │           │             │            │  │              │  │  • 0.0.0.0/0 → Internet Gateway                  │  │ │
│      │  │           │   ┌───────┴───────┐     │            │  │              │  │  • 172.10.0.0/24 → Transit Gateway               │  │ │
│      │  │           │   │               │     │            │  │              │  │  • 10.0.1.0/24 → Transit Gateway                 │  │ │
│      │  │  External │   │  Internal     │     │            │  │              │  │                                                  │  │ │
│      │  │  172.10.0.162 │  10.0.1.1     │     │            │  │              │  └──────────────────────────────────────────────────┘  │ │
│      │  │           │   │               │     │            │  │              │                         │                              │ │
│      │  └───────────┼───┴───────────────┴─────┼────────────┘  │              │  ┌──────────────────────┴───────────────────────────┐  │ │
│      │              │                         │               │              │  │                                                  │  │ │
│      │  ┌───────────┴─────────────────────────┴────────────┐  │              │  │              VPC: 10.100.0.0/16                  │  │ │
│      │  │                                                  │  │              │  │              zta-hybrid-vpc                      │  │ │
│      │  │           ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┓          │  │              │  │                                                  │  │ │
│      │  │           ┃   PUBLIC-NET (Provider)   ┃          │  │              │  │  ┌────────────────────────────────────────────┐  │  │ │
│      │  │           ┃      172.10.0.0/24        ┃          │  │              │  │  │ Internet Gateway: igw-xxxxxxxx            │  │  │ │
│      │  │           ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━┛          │  │              │  │  │ NAT Gateway: nat-xxxxxxxx                 │  │  │ │
│      │  │                                                  │  │              │  │  │ VPC Flow Logs: Enabled                    │  │  │ │
│      │  │  • Floating IP Pool: 172.10.0.100-250            │  │              │  │  └────────────────────────────────────────────┘  │  │ │
│      │  │  • Gateway: 172.10.0.1                           │  │              │  │                                                  │  │ │
│      │  │  • Master Floating IP: 172.10.0.190              │  │              │  └──────────────────────────────────────────────────┘  │ │
│      │  │                                                  │  │              │                         │                              │ │
│      │  └──────────────────────────────────────────────────┘  │              │                         │                              │ │
│      │                         │                              │              │                         │                              │ │
│      └─────────────────────────┼──────────────────────────────┘              └─────────────────────────┼──────────────────────────────┘ │
│                                │                                                                       │                                │
│                                │                                                                       │                                │
│      ┌─────────────────────────┴───────────────────────────────────────────────────────────────────────┴─────────────────────────────┐  │
│      │                                                                                                                               │  │
│      │                                              AWS TRANSIT GATEWAY                                                              │  │
│      │                                              zta-transit-gateway                                                              │  │
│      │                                                                                                                               │  │
│      │  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │  │
│      │  │                                                                                                                         │  │  │
│      │  │   ┌───────────────────────┐    ┌───────────────────────┐    ┌───────────────────────┐    ┌───────────────────────┐     │  │  │
│      │  │   │                       │    │                       │    │                       │    │                       │     │  │  │
│      │  │   │   VPN Attachment      │    │   VPC Attachment      │    │   TGW Route Table     │    │   Customer Gateway    │     │  │  │
│      │  │   │                       │    │                       │    │                       │    │                       │     │  │  │
│      │  │   │  IPSec VPN to         │    │  zta-hybrid-vpc       │    │  Routes:              │    │  OpenStack Router     │     │  │  │
│      │  │   │  OpenStack            │    │  10.100.0.0/16        │    │  • 10.100.0.0/16      │    │  172.10.0.162         │     │  │  │
│      │  │   │                       │    │                       │    │    → VPC Attachment   │    │                       │     │  │  │
│      │  │   │  Tunnel 1: Active     │    │  Subnets:             │    │  • 172.10.0.0/24      │    │  BGP ASN: 65000       │     │  │  │
│      │  │   │  Tunnel 2: Standby    │    │  • 10.100.1.0/24      │    │    → VPN Attachment   │    │  Type: ipsec.1        │     │  │  │
│      │  │   │                       │    │  • 10.100.2.0/24      │    │  • 10.0.1.0/24        │    │                       │     │  │  │
│      │  │   │  Pre-shared Key       │    │                       │    │    → VPN Attachment   │    │  VPN Connection:      │     │  │  │
│      │  │   │  BGP: Dynamic         │    │                       │    │  • 10.42.0.0/16       │    │  2 tunnels (HA)       │     │  │  │
│      │  │   │                       │    │                       │    │    → VPN Attachment   │    │                       │     │  │  │
│      │  │   └───────────────────────┘    └───────────────────────┘    └───────────────────────┘    └───────────────────────┘     │  │  │
│      │  │                                                                                                                         │  │  │
│      │  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │  │
│      │                                                                                                                               │  │
│      │  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │  │
│      │  │                                                                                                                         │  │  │
│      │  │   AWS Site-to-Site VPN                                                                                                  │  │  │
│      │  │   ════════════════════════════════════════════════════════════════════════════════════════════════════                  │  │  │
│      │  │                                                                                                                         │  │  │
│      │  │   ✓ IPSec encryption (AES-256-GCM)                                                                                      │  │  │
│      │  │   ✓ IKEv2 key exchange                                                                                                  │  │  │
│      │  │   ✓ BGP dynamic routing (or static)                                                                                     │  │  │
│      │  │   ✓ Dual tunnels for high availability                                                                                  │  │  │
│      │  │   ✓ ~20-50ms latency (Vietnam → Singapore)                                                                              │  │  │
│      │  │   ✓ Up to 1.25 Gbps per tunnel                                                                                          │  │  │
│      │  │                                                                                                                         │  │  │
│      │  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │  │
│      │                                                                                                                               │  │
│      └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                                                         │
│                                                            INTERNET                                                                     │
│                                                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Chi tiết Topology Mạng theo Layer

### Layer 2/3 - OpenStack Network Topology

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                           OPENSTACK NETWORK TOPOLOGY (Neutron)                               │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│                                    ┌─────────────────┐                                      │
│                                    │    INTERNET     │                                      │
│                                    └────────┬────────┘                                      │
│                                             │                                               │
│   ══════════════════════════════════════════╪═══════════════════════════════════════════   │
│   ║                        PUBLIC-NET (Provider Network)                               ║   │
│   ║                              172.10.0.0/24                                         ║   │
│   ║                              VLAN: Flat/Untagged                                   ║   │
│   ══════════════════════════════════════════╪═══════════════════════════════════════════   │
│                                             │                                               │
│                                             │ 172.10.0.162 (External Gateway)               │
│                                             │                                               │
│                                    ╔════════╧════════╗                                      │
│                                    ║       r1        ║                                      │
│                                    ║    (Router)     ║                                      │
│                                    ║                 ║                                      │
│                                    ║  NAT: Enabled   ║                                      │
│                                    ║  SNAT: Auto     ║                                      │
│                                    ╚════════╤════════╝                                      │
│                                             │                                               │
│                                             │ 10.0.1.1 (Internal Gateway)                   │
│                                             │                                               │
│   ══════════════════════════════════════════╪═══════════════════════════════════════════   │
│   ║                       PRIVATE-NET (Tenant Network)                                 ║   │
│   ║                              10.0.1.0/24                                           ║   │
│   ║                              VXLAN/GRE Encapsulation                               ║   │
│   ══════════════════════════════════════════╪═══════════════════════════════════════════   │
│                                             │                                               │
│                          ┌──────────────────┼──────────────────┐                            │
│                          │                  │                  │                            │
│                          │                  │                  │                            │
│                 ┌────────┴────────┐  ┌──────┴──────┐  ┌────────┴────────┐                   │
│                 │                 │  │             │  │                 │                   │
│                 │     master      │  │   worker    │  │   (Future VMs)  │                   │
│                 │   10.0.1.185    │  │  10.0.1.65  │  │                 │                   │
│                 │                 │  │             │  │                 │                   │
│                 │  Floating IP:   │  │             │  │                 │                   │
│                 │  172.10.0.190   │  │             │  │                 │                   │
│                 │                 │  │             │  │                 │                   │
│                 │  K3s Server     │  │ K3s Agent   │  │                 │                   │
│                 │  Control Plane  │  │ Workloads   │  │                 │                   │
│                 │                 │  │             │  │                 │                   │
│                 └─────────────────┘  └─────────────┘  └─────────────────┘                   │
│                                                                                             │
│   ┌───────────────────────────────────────────────────────────────────────────────────┐    │
│   │                              ROUTING TABLE (r1)                                    │    │
│   ├───────────────────────────────────────────────────────────────────────────────────┤    │
│   │  Destination         │  Next Hop        │  Interface    │  Notes                  │    │
│   ├──────────────────────┼──────────────────┼───────────────┼─────────────────────────┤    │
│   │  0.0.0.0/0           │  172.10.0.1      │  qg-external  │  Default route          │    │
│   │  10.0.1.0/24         │  local           │  qr-internal  │  Tenant network         │    │
│   │  172.10.0.0/24       │  local           │  qg-external  │  Provider network       │    │
│   │  10.100.0.0/16       │  VPN Tunnel      │  ipsec0       │  AWS VPC via TGW        │    │
│   │  10.42.3.0/24        │  VPN Tunnel      │  ipsec0       │  AWS Pod network        │    │
│   └──────────────────────┴──────────────────┴───────────────┴─────────────────────────┘    │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### Layer 2/3 - AWS VPC Network Topology

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                               AWS VPC NETWORK TOPOLOGY                                       │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│                                    ┌─────────────────┐                                      │
│                                    │    INTERNET     │                                      │
│                                    └────────┬────────┘                                      │
│                                             │                                               │
│                                    ┌────────┴────────┐                                      │
│                                    │  Internet GW    │                                      │
│                                    │  igw-xxxxxxxx   │                                      │
│                                    └────────┬────────┘                                      │
│                                             │                                               │
│   ┌─────────────────────────────────────────┴─────────────────────────────────────────────┐ │
│   │                                                                                       │ │
│   │                              VPC: 10.100.0.0/16                                       │ │
│   │                              zta-hybrid-vpc                                           │ │
│   │                              Region: ap-southeast-1                                   │ │
│   │                                                                                       │ │
│   │  ┌─────────────────────────────────────┐  ┌─────────────────────────────────────┐    │ │
│   │  │                                     │  │                                     │    │ │
│   │  │        PUBLIC SUBNET                │  │        PRIVATE SUBNET               │    │ │
│   │  │        10.100.1.0/24                │  │        10.100.2.0/24                │    │ │
│   │  │        AZ: ap-southeast-1a          │  │        AZ: ap-southeast-1a          │    │ │
│   │  │                                     │  │                                     │    │ │
│   │  │  ┌───────────────────────────────┐  │  │  ┌───────────────────────────────┐  │    │ │
│   │  │  │                               │  │  │  │                               │  │    │ │
│   │  │  │   VPN Gateway Instance        │  │  │  │   K3s Worker Node             │  │    │ │
│   │  │  │   (Customer GW Endpoint)      │  │  │  │   aws-worker-1                │  │    │ │
│   │  │  │                               │  │  │  │                               │  │    │ │
│   │  │  │   Public: 18.143.117.69       │  │  │  │   Private: 10.100.2.50        │  │    │ │
│   │  │  │   Private: 10.100.1.x         │  │  │  │                               │  │    │ │
│   │  │  │                               │  │  │  │   ┌───────────────────────┐   │  │    │ │
│   │  │  │   Security Group:             │  │  │  │   │ TKB-Service Pod       │   │  │    │ │
│   │  │  │   • UDP 500 (IKE)             │  │  │  │   │ NodePort: 30080       │   │  │    │ │
│   │  │  │   • UDP 4500 (NAT-T)          │  │  │  │   │ Container: 3000       │   │  │    │ │
│   │  │  │   • ESP Protocol (50)         │  │  │  │   └───────────────────────┘   │  │    │ │
│   │  │  │                               │  │  │  │                               │  │    │ │
│   │  │  └───────────────────────────────┘  │  │  │   Security Group:             │  │    │ │
│   │  │                                     │  │  │   • All from VPN GW only      │  │    │ │
│   │  │  ┌───────────────────────────────┐  │  │  │   • All from VPC CIDR         │  │    │ │
│   │  │  │   NAT Gateway                 │  │  │  │                               │  │    │ │
│   │  │  │   nat-xxxxxxxx                │  │  │  └───────────────────────────────┘  │    │ │
│   │  │  │   EIP: x.x.x.x                │  │  │                                     │    │ │
│   │  │  └───────────────────────────────┘  │  │                                     │    │ │
│   │  │                                     │  │                                     │    │ │
│   │  │  Route Table (Public):              │  │  Route Table (Private):             │    │ │
│   │  │  • 0.0.0.0/0 → IGW                  │  │  • 0.0.0.0/0 → NAT GW               │    │ │
│   │  │  • 172.10.0.0/24 → TGW              │  │  • 172.10.0.0/24 → TGW              │    │ │
│   │  │  • 10.0.1.0/24 → TGW                │  │  • 10.0.1.0/24 → TGW                │    │ │
│   │  │                                     │  │  • 10.42.0.0/16 → TGW               │    │ │
│   │  └─────────────────────────────────────┘  └─────────────────────────────────────┘    │ │
│   │                                                                                       │ │
│   └───────────────────────────────────────────────────────────────────────────────────────┘ │
│                          │                                                                  │
│                          │ TGW Attachment                                                   │
│                          │                                                                  │
│   ┌──────────────────────┴──────────────────────────────────────────────────────────────┐   │
│   │                                                                                      │   │
│   │                           AWS TRANSIT GATEWAY                                        │   │
│   │                           Amazon ASN: 64512                                          │   │
│   │                                                                                      │   │
│   │  ┌────────────────────────────────────────────────────────────────────────────────┐ │   │
│   │  │                         TRANSIT GATEWAY ROUTE TABLE                            │ │   │
│   │  ├────────────────────────────────────────────────────────────────────────────────┤ │   │
│   │  │  Destination         │  Attachment           │  Type         │  Status        │ │   │
│   │  ├──────────────────────┼───────────────────────┼───────────────┼────────────────┤ │   │
│   │  │  10.100.0.0/16       │  vpc-attachment       │  VPC          │  Active        │ │   │
│   │  │  172.10.0.0/24       │  vpn-attachment       │  VPN          │  Active        │ │   │
│   │  │  10.0.1.0/24         │  vpn-attachment       │  VPN          │  Active        │ │   │
│   │  │  10.42.0.0/24        │  vpn-attachment       │  VPN          │  Active        │ │   │
│   │  │  10.42.1.0/24        │  vpn-attachment       │  VPN          │  Active        │ │   │
│   │  └──────────────────────┴───────────────────────┴───────────────┴────────────────┘ │   │
│   │                                                                                      │   │
│   │                    │                                                                 │   │
│   │                    │ VPN Attachment (Site-to-Site VPN)                               │   │
│   │                    │                                                                 │   │
│   └────────────────────┼─────────────────────────────────────────────────────────────────┘   │
│                        │                                                                     │
│   ┌────────────────────┴─────────────────────────────────────────────────────────────────┐   │
│   │                                                                                      │   │
│   │                        AWS SITE-TO-SITE VPN CONNECTION                               │   │
│   │                                                                                      │   │
│   │  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────────────────┐ │   │
│   │  │                    │  │                    │  │                                │ │   │
│   │  │   TUNNEL 1         │  │   TUNNEL 2         │  │   CUSTOMER GATEWAY             │ │   │
│   │  │   (Active)         │  │   (Standby)        │  │                                │ │   │
│   │  │                    │  │                    │  │   Name: zta-openstack-cgw      │ │   │
│   │  │   Outside IP:      │  │   Outside IP:      │  │   IP: 172.10.0.162             │ │   │
│   │  │   AWS Endpoint 1   │  │   AWS Endpoint 2   │  │   BGP ASN: 65000               │ │   │
│   │  │                    │  │                    │  │   Type: ipsec.1                │ │   │
│   │  │   Inside CIDR:     │  │   Inside CIDR:     │  │                                │ │   │
│   │  │   169.254.x.x/30   │  │   169.254.y.y/30   │  │   Routing: BGP Dynamic         │ │   │
│   │  │                    │  │                    │  │   or Static Routes             │ │   │
│   │  │   PSK: ********    │  │   PSK: ********    │  │                                │ │   │
│   │  │                    │  │                    │  │                                │ │   │
│   │  └────────────────────┘  └────────────────────┘  └────────────────────────────────┘ │   │
│   │                                                                                      │   │
│   └──────────────────────────────────────────────────────────────────────────────────────┘   │
│                                             │                                                │
│                                             │ IPSec Tunnel (Encrypted)                       │
│                                             │                                                │
└─────────────────────────────────────────────┼────────────────────────────────────────────────┘
                                              │
                                              ▼
                                    ┌─────────────────┐
                                    │   TO OPENSTACK  │
                                    │   172.10.0.162  │
                                    └─────────────────┘
```

---

## Overlay Networks

### Kubernetes Overlay (Flannel VXLAN)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                            KUBERNETES OVERLAY NETWORK (Flannel)                              │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   Pod Network CIDR: 10.42.0.0/16                                                            │
│   Service Network: 10.43.0.0/16                                                             │
│   CNI: Flannel with VXLAN backend                                                           │
│   VXLAN VNI: 1                                                                              │
│   VXLAN Port: UDP 8472                                                                      │
│                                                                                             │
│   ┌───────────────────────────────────────┐    ┌───────────────────────────────────────┐   │
│   │         OPENSTACK NODES               │    │            AWS NODE                   │   │
│   │                                       │    │                                       │   │
│   │  ┌─────────────────┐ ┌──────────────┐ │    │  ┌─────────────────────────────────┐  │   │
│   │  │  Master Node    │ │ Worker Node  │ │    │  │        aws-worker-1             │  │   │
│   │  │                 │ │              │ │    │  │                                 │  │   │
│   │  │  Pod CIDR:      │ │ Pod CIDR:    │ │    │  │  Pod CIDR: 10.42.3.0/24         │  │   │
│   │  │  10.42.0.0/24   │ │ 10.42.1.0/24 │ │    │  │                                 │  │   │
│   │  │                 │ │              │ │    │  │  ┌─────────────────────────┐    │  │   │
│   │  │  flannel.1:     │ │ flannel.1:   │ │    │  │  │    tkb-service Pod      │    │  │   │
│   │  │  10.42.0.0      │ │ 10.42.1.0    │ │    │  │  │    10.42.3.x            │    │  │   │
│   │  │  (VTEP)         │ │ (VTEP)       │ │    │  │  └─────────────────────────┘    │  │   │
│   │  │                 │ │              │ │    │  │                                 │  │   │
│   │  │  cni0 bridge    │ │ cni0 bridge  │ │    │  │  flannel.1: 10.42.3.0 (VTEP)   │  │   │
│   │  │                 │ │              │ │    │  │  cni0 bridge                    │  │   │
│   │  └────────┬────────┘ └──────┬───────┘ │    │  └────────────────┬────────────────┘  │   │
│   │           │                 │         │    │                   │                   │   │
│   │           └────────┬────────┘         │    │                   │                   │   │
│   │                    │                  │    │                   │                   │   │
│   └────────────────────┼──────────────────┘    └───────────────────┼───────────────────┘   │
│                        │                                           │                       │
│                        │         VXLAN TUNNEL (VNI 1)              │                       │
│                        │◄═══════════════════════════════════════════►                      │
│                        │      Encapsulated in VPN Tunnel           │                       │
│                        │                                           │                       │
└────────────────────────┴───────────────────────────────────────────┴───────────────────────┘
```

### Istio Service Mesh Overlay (mTLS)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                            ISTIO SERVICE MESH OVERLAY (mTLS)                                 │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   Trust Domain: cluster.local                                                               │
│   mTLS Mode: STRICT                                                                         │
│   Certificate Authority: Istiod (or SPIRE integration)                                      │
│                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                     │   │
│   │                              OPENSTACK PODS                                         │   │
│   │                                                                                     │   │
│   │   ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐              │   │
│   │   │    demo-app       │  │   oauth2-proxy    │  │     keycloak      │              │   │
│   │   │    ┌───────────┐  │  │    ┌───────────┐  │  │    ┌───────────┐  │              │   │
│   │   │    │  Envoy    │  │  │    │  Envoy    │  │  │    │  Envoy    │  │              │   │
│   │   │    │  Sidecar  │  │  │    │  Sidecar  │  │  │    │  Sidecar  │  │              │   │
│   │   │    └─────┬─────┘  │  │    └─────┬─────┘  │  │    └─────┬─────┘  │              │   │
│   │   │          │        │  │          │        │  │          │        │              │   │
│   │   │   SPIFFE ID:      │  │   SPIFFE ID:      │  │   SPIFFE ID:      │              │   │
│   │   │   spiffe://       │  │   spiffe://       │  │   spiffe://       │              │   │
│   │   │   cluster.local/  │  │   cluster.local/  │  │   cluster.local/  │              │   │
│   │   │   ns/demo/        │  │   ns/demo/        │  │   ns/demo/        │              │   │
│   │   │   sa/demo-app     │  │   sa/oauth2-proxy │  │   sa/keycloak     │              │   │
│   │   └───────────────────┘  └───────────────────┘  └───────────────────┘              │   │
│   │            │                      │                      │                         │   │
│   │            └──────────────────────┼──────────────────────┘                         │   │
│   │                                   │                                                │   │
│   │                          mTLS encrypted                                            │   │
│   │                                   │                                                │   │
│   └───────────────────────────────────┼────────────────────────────────────────────────┘   │
│                                       │                                                     │
│                                       │  mTLS over VPN                                      │
│                                       │                                                     │
│   ┌───────────────────────────────────┼────────────────────────────────────────────────┐   │
│   │                                   │                                                │   │
│   │                              AWS PODS                                              │   │
│   │                                   │                                                │   │
│   │              ┌────────────────────┴────────────────────┐                           │   │
│   │              │                                         │                           │   │
│   │              │            tkb-service                  │                           │   │
│   │              │            ┌───────────┐                │                           │   │
│   │              │            │  Envoy    │                │                           │   │
│   │              │            │  Sidecar  │                │                           │   │
│   │              │            └─────┬─────┘                │                           │   │
│   │              │                  │                      │                           │   │
│   │              │           SPIFFE ID:                    │                           │   │
│   │              │           spiffe://cluster.local/       │                           │   │
│   │              │           ns/microservices/             │                           │   │
│   │              │           sa/tkb-service                │                           │   │
│   │              │                                         │                           │   │
│   │              └─────────────────────────────────────────┘                           │   │
│   │                                                                                    │   │
│   └────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Bảng So sánh: WireGuard vs AWS Transit Gateway

| Tiêu chí | WireGuard VPN | AWS Transit Gateway + Site-to-Site VPN |
|----------|---------------|----------------------------------------|
| **Encryption** | ChaCha20-Poly1305 | AES-256-GCM (IPSec) |
| **Key Exchange** | Curve25519 | IKEv2 |
| **Bandwidth** | ~100-500 Mbps | 1.25 Gbps per tunnel |
| **High Availability** | Manual (single tunnel) | Built-in (dual tunnels) |
| **Routing** | Static only | BGP dynamic or Static |
| **Scalability** | Limited | Multiple VPC attachments |
| **Managed by** | Self-managed | AWS managed |
| **Cost** | Free (self-hosted) | ~$0.05/hr + data transfer |
| **Use Case** | Lab/Dev/Small prod | Enterprise production |
| **Monitoring** | Manual | CloudWatch integration |

---

## IP Address Summary

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                  IP ADDRESS ALLOCATION                                       │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  OPENSTACK                              │  AWS                                              │
│  ═══════════════════════════════════════│═══════════════════════════════════════════════   │
│                                         │                                                   │
│  Provider Network: 172.10.0.0/24        │  VPC CIDR: 10.100.0.0/16                         │
│  ├── Gateway: 172.10.0.1                │  ├── Public Subnet: 10.100.1.0/24               │
│  ├── Router External: 172.10.0.162      │  │   └── VPN GW Instance: 10.100.1.x            │
│  └── Master Floating: 172.10.0.190      │  │       Public IP: 18.143.117.69               │
│                                         │  │                                               │
│  Tenant Network: 10.0.1.0/24            │  └── Private Subnet: 10.100.2.0/24              │
│  ├── Router Internal: 10.0.1.1          │      └── K3s Worker: 10.100.2.50                │
│  ├── Master VM: 10.0.1.185              │                                                  │
│  └── Worker VM: 10.0.1.65               │  Transit Gateway: tgw-xxxxxxxxx                  │
│                                         │  ├── Amazon ASN: 64512                          │
│  K8s Pod Network: 10.42.0.0/16          │  └── VPN Attachment: vpn-xxxxxxxxx              │
│  ├── Master Pods: 10.42.0.0/24          │                                                  │
│  ├── Worker Pods: 10.42.1.0/24          │  Customer Gateway: cgw-xxxxxxxxx                 │
│  └── AWS Pods: 10.42.3.0/24             │  ├── OpenStack Public IP: 172.10.0.162          │
│                                         │  └── BGP ASN: 65000                             │
│  K8s Service Network: 10.43.0.0/16      │                                                  │
│                                         │  VPN Tunnels (IPSec):                           │
│  VPN Tunnel (inside): 169.254.x.x/30    │  ├── Tunnel 1: 169.254.x.x/30                   │
│                                         │  └── Tunnel 2: 169.254.y.y/30                   │
│                                         │                                                  │
└─────────────────────────────────────────┴──────────────────────────────────────────────────┘
```

---

## Traffic Flow: Cross-Cloud Communication

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                    REQUEST FLOW: demo-app (OpenStack) → tkb-service (AWS)                    │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  ① demo-app Pod (10.42.0.x) → HTTP request to tkb-service                                  │
│                    │                                                                        │
│                    ▼                                                                        │
│  ② Envoy Sidecar encrypts with mTLS (SPIFFE ID verification)                               │
│                    │                                                                        │
│                    ▼                                                                        │
│  ③ Flannel CNI routes to Node (destination not in local Pod CIDR)                          │
│                    │                                                                        │
│                    ▼                                                                        │
│  ④ Linux routing table → route to AWS via VPN tunnel                                       │
│                    │                                                                        │
│                    ▼                                                                        │
│  ⑤ IPSec encryption (AES-256-GCM) → through Customer Gateway (172.10.0.162)               │
│                    │                                                                        │
│                    ▼                                                                        │
│  ⑥ Internet transit (encrypted IPSec tunnel) → AWS VPN endpoint                            │
│                    │                                                                        │
│                    ▼                                                                        │
│  ⑦ AWS Transit Gateway receives packet → routes to VPC attachment                          │
│                    │                                                                        │
│                    ▼                                                                        │
│  ⑧ VPC Route Table → Private Subnet → K3s Worker Node (10.100.2.50)                        │
│                    │                                                                        │
│                    ▼                                                                        │
│  ⑨ kube-proxy (iptables) → NodePort 30080 → tkb-service Pod                                │
│                    │                                                                        │
│                    ▼                                                                        │
│  ⑩ Envoy Sidecar decrypts mTLS → tkb-service receives request                              │
│                    │                                                                        │
│                    ▼                                                                        │
│  ⑪ tkb-service processes request → returns TKB data based on role                          │
│                    │                                                                        │
│                    ▼                                                                        │
│  ⑫ Response travels back through same path (reversed)                                      │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```
