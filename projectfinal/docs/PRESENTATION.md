# ğŸ“ BÃ€I THUYáº¾T TRÃŒNH Äá»’ ÃN
# ZERO TRUST ARCHITECTURE TRÃŠN MÃ”I TRÆ¯á»œNG HYBRID CLOUD

---

## ğŸ“Œ THÃ”NG TIN Äá»’ ÃN

| ThÃ´ng tin | Chi tiáº¿t |
|-----------|----------|
| **TÃªn Ä‘á» tÃ i** | Triá»ƒn khai Zero Trust Architecture trÃªn Hybrid Cloud |
| **MÃ´i trÆ°á»ng** | OpenStack (On-Premises) + AWS (Public Cloud) |
| **CÃ´ng nghá»‡ chÃ­nh** | K3s, Istio, Keycloak, WireGuard, Terraform |

---

# PHáº¦N 1: Tá»”NG QUAN ZERO TRUST

## 1.1 Zero Trust lÃ  gÃ¬?

> **"Never Trust, Always Verify"** - KhÃ´ng bao giá» tin tÆ°á»Ÿng, luÃ´n xÃ¡c thá»±c

Zero Trust lÃ  mÃ´ hÃ¬nh báº£o máº­t hiá»‡n Ä‘áº¡i, khÃ¡c biá»‡t hoÃ n toÃ n vá»›i mÃ´ hÃ¬nh truyá»n thá»‘ng:

| MÃ´ hÃ¬nh truyá»n thá»‘ng | Zero Trust |
|---------------------|------------|
| Tin tÆ°á»Ÿng máº¡ng ná»™i bá»™ | KhÃ´ng tin tÆ°á»Ÿng báº¥t ká»³ ai |
| Firewall báº£o vá»‡ perimeter | Báº£o vá»‡ tá»«ng resource |
| VPN = Full access | Micro-segmentation |
| XÃ¡c thá»±c 1 láº§n | XÃ¡c thá»±c liÃªn tá»¥c |

## 1.2 Bá»‘n nguyÃªn táº¯c Zero Trust Ä‘Ã£ triá»ƒn khai

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    4 NGUYÃŠN Táº®C ZERO TRUST                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1ï¸âƒ£  NEVER TRUST, ALWAYS VERIFY                                    â”‚
â”‚      â†’ Má»i request PHáº¢I qua Keycloak xÃ¡c thá»±c                      â”‚
â”‚      â†’ KhÃ´ng cÃ³ exception, khÃ´ng cÃ³ bypass                         â”‚
â”‚                                                                     â”‚
â”‚  2ï¸âƒ£  LEAST PRIVILEGE ACCESS (enforced by OPA)                      â”‚
â”‚      â†’ OPA Policy Engine Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh authorization           â”‚
â”‚      â†’ Rego Policy: giangvien/sinhvien cÃ³ quyá»n khÃ¡c nhau          â”‚
â”‚      â†’ Default DENY - khÃ´ng cÃ³ quyá»n máº·c Ä‘á»‹nh                      â”‚
â”‚                                                                     â”‚
â”‚  3ï¸âƒ£  ASSUME BREACH                                                 â”‚
â”‚      â†’ MÃ£ hÃ³a traffic ngay cáº£ trong internal network               â”‚
â”‚      â†’ WireGuard VPN giá»¯a 2 cloud                                  â”‚
â”‚      â†’ Istio mTLS giá»¯a cÃ¡c microservices                           â”‚
â”‚      â†’ SPIFFE/SPIRE: Workload Identity, short-lived certs          â”‚
â”‚                                                                     â”‚
â”‚  4ï¸âƒ£  VERIFY EXPLICITLY                                             â”‚
â”‚      â†’ Headers Ä‘Æ°á»£c set bá»Ÿi OAuth2-Proxy, khÃ´ng pháº£i user          â”‚
â”‚      â†’ JWT tokens Ä‘Æ°á»£c verify signature vá»›i Keycloak               â”‚
â”‚      â†’ SPIFFE IDs xÃ¡c minh workload identity                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# PHáº¦N 2: KIáº¾N TRÃšC Há»† THá»NG

## 2.1 Hybrid Cloud Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              HYBRID CLOUD ARCHITECTURE                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚      OPENSTACK             â”‚         â”‚         AWS                â”‚     â”‚
â”‚   â”‚   (On-Premises DC)         â”‚         â”‚   (Singapore Region)       â”‚     â”‚
â”‚   â”‚                            â”‚         â”‚                            â”‚     â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚
â”‚   â”‚  â”‚    K3s Master        â”‚  â”‚         â”‚  â”‚   K3s Worker         â”‚  â”‚     â”‚
â”‚   â”‚  â”‚    10.0.1.185        â”‚  â”‚         â”‚  â”‚   (aws-worker-1)     â”‚  â”‚     â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â”‚                      â”‚  â”‚     â”‚
â”‚   â”‚                            â”‚         â”‚  â”‚   TKB Microservice   â”‚  â”‚     â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”‚   NodePort: 30080    â”‚  â”‚     â”‚
â”‚   â”‚  â”‚    K3s Worker        â”‚  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚
â”‚   â”‚  â”‚    10.0.1.65         â”‚  â”‚         â”‚                            â”‚     â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚
â”‚   â”‚                            â”‚         â”‚  â”‚   WireGuard Gateway  â”‚  â”‚     â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚  â”‚   18.143.117.69      â”‚  â”‚     â”‚
â”‚   â”‚  â”‚   WireGuard Tunnel   â”‚  â”‚   VPN   â”‚  â”‚   10.200.0.1         â”‚  â”‚     â”‚
â”‚   â”‚  â”‚   10.200.0.2         â”‚  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                            â”‚     â”‚
â”‚   â”‚                            â”‚         â”‚                            â”‚     â”‚
â”‚   â”‚   Network: 172.10.0.0/24   â”‚         â”‚   VPC: 10.100.0.0/16      â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                              â”‚
â”‚                    â–²                                                         â”‚
â”‚                    â”‚                                                         â”‚
â”‚                    â”‚  WireGuard VPN Tunnel                                   â”‚
â”‚                    â”‚  â€¢ ChaCha20-Poly1305 encryption                         â”‚
â”‚                    â”‚  â€¢ Curve25519 key exchange                              â”‚
â”‚                    â”‚  â€¢ ~45ms latency (OpenStack â†” Singapore)                â”‚
â”‚                    â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2.2 Application Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AUTHENTICATION FLOW                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚    User Browser                                                              â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â”‚ â‘  Request: http://app.172.10.0.190.nip.io:31691/                   â”‚
â”‚        â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚   â”‚  Istio Gateway  â”‚  Single entry point (Zero Trust perimeter)            â”‚
â”‚   â”‚  NodePort:31691 â”‚                                                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚            â”‚                                                                 â”‚
â”‚            â”‚ â‘¡ Route via VirtualService                                      â”‚
â”‚            â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      No session?      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚  OAuth2-Proxy   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚    Keycloak     â”‚             â”‚
â”‚   â”‚  (Auth Gateway) â”‚      â‘¢ Redirect       â”‚   (OIDC IdP)    â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚            â”‚              â‘£ JWT Token                                        â”‚
â”‚            â”‚                                                                 â”‚
â”‚            â”‚ â‘¤ Set trusted headers:                                          â”‚
â”‚            â”‚    x-forwarded-user: "gv1"                                      â”‚
â”‚            â”‚    x-forwarded-groups: "giangvien"                              â”‚
â”‚            â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚   â”‚       OPA       â”‚â—„â”€â”€â”€â”€â”€â”‚    Demo-App     â”‚  â‘¥ Check authorization      â”‚
â”‚   â”‚ (Policy Engine) â”‚      â”‚   (FastAPI)     â”‚                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚     Rego policy check               â”‚                                        â”‚
â”‚     ALLOW / DENY                    â”‚ â‘¦ /api/tkb â†’ Forward to AWS          â”‚
â”‚                                     â”‚    via WireGuard VPN                   â”‚
â”‚                                     â–¼                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚   â”‚  SPIRE Server   â”‚      â”‚  TKB Service    â”‚  â‘§ Return data based on roleâ”‚
â”‚   â”‚ (Workload ID)   â”‚      â”‚  (AWS Node.js)  â”‚     giangvien â†’ TKB GV      â”‚
â”‚   â”‚ Trust: zta.localâ”‚      â”‚  10.200.0.1     â”‚     sinhvien  â†’ TKB SV      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# PHáº¦N 3: NHá»®NG KHÃ“ KHÄ‚N ÄÃƒ VÆ¯á»¢T QUA

## 3.1 ğŸ”¥ KhÃ³ khÄƒn #1: Join AWS Worker vÃ o K3s Cluster qua WireGuard

### Váº¥n Ä‘á» gáº·p pháº£i:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ Láº¦N THá»¬ Äáº¦U TIÃŠN - THáº¤T Báº I                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  AWS Worker join vá»›i Private IP (10.100.1.185):                    â”‚
â”‚                                                                     â”‚
â”‚  $ k3s agent --server https://172.10.0.190:6443 \                  â”‚
â”‚              --token xxx \                                          â”‚
â”‚              --node-name aws-worker-1                               â”‚
â”‚                                                                     â”‚
â”‚  Káº¿t quáº£:                                                           â”‚
â”‚  $ kubectl get nodes -o wide                                        â”‚
â”‚  NAME           INTERNAL-IP      STATUS                             â”‚
â”‚  master         10.0.1.185       Ready                              â”‚
â”‚  worker         10.0.1.65        Ready                              â”‚
â”‚  aws-worker-1   10.100.1.185     Ready    â† SAI! KhÃ´ng route Ä‘Æ°á»£c  â”‚
â”‚                                                                     â”‚
â”‚  âŒ OpenStack nodes khÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n 10.100.1.185             â”‚
â”‚  âŒ Pod scheduling tháº¥t báº¡i                                         â”‚
â”‚  âŒ Flannel VXLAN khÃ´ng hoáº¡t Ä‘á»™ng cross-cloud                       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Giáº£i phÃ¡p thÃ nh cÃ´ng:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… GIáº¢I PHÃP: Sá»¬ Dá»¤NG WIREGUARD IP LÃ€M NODE IP                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  BÆ°á»›c 1: Thiáº¿t láº­p WireGuard VPN trÆ°á»›c                             â”‚
â”‚                                                                     â”‚
â”‚  OpenStack (10.200.0.2) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º AWS (10.200.0.1)              â”‚
â”‚                          Encrypted                                  â”‚
â”‚                                                                     â”‚
â”‚  BÆ°á»›c 2: Join vá»›i --node-ip lÃ  WireGuard IP                        â”‚
â”‚                                                                     â”‚
â”‚  $ k3s agent --server https://10.200.0.2:6443 \                    â”‚
â”‚              --token xxx \                                          â”‚
â”‚              --node-name aws-worker-1 \                             â”‚
â”‚              --node-ip 10.200.0.1      â† WIREGUARD IP!             â”‚
â”‚                                                                     â”‚
â”‚  Káº¿t quáº£:                                                           â”‚
â”‚  $ kubectl get nodes -o wide                                        â”‚
â”‚  NAME           INTERNAL-IP    STATUS                               â”‚
â”‚  master         10.0.1.185     Ready                                â”‚
â”‚  worker         10.0.1.65      Ready                                â”‚
â”‚  aws-worker-1   10.200.0.1     Ready    â† ÄÃšNG! Route qua VPN      â”‚
â”‚                                                                     â”‚
â”‚  âœ… Traffic K3s Ä‘i qua WireGuard tunnel                            â”‚
â”‚  âœ… MÃ£ hÃ³a end-to-end giá»¯a 2 cloud                                 â”‚
â”‚  âœ… Pod cÃ³ thá»ƒ schedule lÃªn AWS worker                              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Chá»©ng minh vá»›i lá»‡nh:

```bash
# Kiá»ƒm tra node IP lÃ  WireGuard IP
kubectl get nodes -o wide
# aws-worker-1   10.200.0.1   Ready

# Ping qua VPN tunnel
ping -c 3 10.200.0.1
# 64 bytes from 10.200.0.1: time=45.2 ms  â† Latency Ä‘áº¿n Singapore

# Kiá»ƒm tra WireGuard handshake
sudo wg show
# peer: F1VpZHOB...
#   endpoint: 18.143.117.69:51820
#   latest handshake: 23 seconds ago  â† VPN active
```

---

## 3.2 ğŸ”¥ KhÃ³ khÄƒn #2: Istio Sidecar khÃ´ng hoáº¡t Ä‘á»™ng trÃªn AWS Worker

### Váº¥n Ä‘á» gáº·p pháº£i:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ ISTIO SIDECAR CRASH LOOP TRÃŠN AWS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  $ kubectl get pods -n microservices                                â”‚
â”‚  NAME                          READY   STATUS                       â”‚
â”‚  tkb-service-xxx               1/2     CrashLoopBackOff             â”‚
â”‚                                                                     â”‚
â”‚  $ kubectl describe pod tkb-service-xxx                             â”‚
â”‚  Warning  Unhealthy  Startup probe failed                          â”‚
â”‚  Warning  Unhealthy  istio-proxy: connection refused               â”‚
â”‚                                                                     â”‚
â”‚  NguyÃªn nhÃ¢n:                                                       â”‚
â”‚  â€¢ Istio control plane á»Ÿ OpenStack                                 â”‚
â”‚  â€¢ Sidecar trÃªn AWS khÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c istiod                      â”‚
â”‚  â€¢ Cross-cloud CNI (Flannel) + Istio = phá»©c táº¡p                    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Giáº£i phÃ¡p thÃ nh cÃ´ng:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… GIáº¢I PHÃP: DISABLE ISTIO CHO MICROSERVICES NAMESPACE           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  # Táº¡o namespace riÃªng cho workloads AWS                           â”‚
â”‚  kubectl create namespace microservices                             â”‚
â”‚                                                                     â”‚
â”‚  # KHÃ”NG label istio-injection                                      â”‚
â”‚  # (khÃ¡c vá»›i namespace demo cÃ³ istio-injection=enabled)            â”‚
â”‚                                                                     â”‚
â”‚  # Deploy TKB vá»›i NodePort thay vÃ¬ ClusterIP                       â”‚
â”‚  apiVersion: v1                                                     â”‚
â”‚  kind: Service                                                      â”‚
â”‚  spec:                                                              â”‚
â”‚    type: NodePort                                                   â”‚
â”‚    ports:                                                           â”‚
â”‚    - port: 3000                                                     â”‚
â”‚      nodePort: 30080    â† Truy cáº­p trá»±c tiáº¿p qua WireGuard IP      â”‚
â”‚                                                                     â”‚
â”‚  # Access tá»« OpenStack:                                             â”‚
â”‚  curl http://10.200.0.1:30080/api/tkb                              â”‚
â”‚            â–²                                                        â”‚
â”‚            â””â”€â”€ WireGuard IP + NodePort                              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**BÃ i há»c:** Trong Hybrid Cloud, khÃ´ng pháº£i má»i thá»© Ä‘á»u cáº§n Service Mesh. NodePort + VPN lÃ  giáº£i phÃ¡p pragmatic.

---

## 3.3 ğŸ”¥ KhÃ³ khÄƒn #3: Header Injection Prevention

### Váº¥n Ä‘á» báº£o máº­t:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ NGUY CÆ : ATTACKER GIáº¢ Máº O HEADERS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Attacker thá»­ bypass authentication:                               â”‚
â”‚                                                                     â”‚
â”‚  $ curl -H "x-forwarded-user: admin" \                             â”‚
â”‚         -H "x-forwarded-groups: giangvien" \                       â”‚
â”‚         http://app.172.10.0.190.nip.io:31691/api/giangvien         â”‚
â”‚                                                                     â”‚
â”‚  Náº¿u app tin vÃ o headers nÃ y â†’ FULL ACCESS khÃ´ng cáº§n Ä‘Äƒng nháº­p!   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Giáº£i phÃ¡p trong há»‡ thá»‘ng:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… OAUTH2-PROXY STRIPS INCOMING HEADERS                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  OAuth2-Proxy configuration:                                        â”‚
â”‚                                                                     â”‚
â”‚  --pass-user-headers=true                                          â”‚
â”‚  --set-xauthrequest=true                                           â”‚
â”‚  --pass-access-token=true                                          â”‚
â”‚                                                                     â”‚
â”‚  Luá»“ng xá»­ lÃ½:                                                       â”‚
â”‚                                                                     â”‚
â”‚  1. Request Ä‘áº¿n vá»›i fake headers                                   â”‚
â”‚     x-forwarded-user: "admin"  â† Tá»« attacker                       â”‚
â”‚                                                                     â”‚
â”‚  2. OAuth2-Proxy kiá»ƒm tra session cookie                           â”‚
â”‚     â†’ KhÃ´ng cÃ³ valid session â†’ Redirect to Keycloak                â”‚
â”‚                                                                     â”‚
â”‚  3. Náº¿u cÃ³ valid session, OAuth2-Proxy:                            â”‚
â”‚     â†’ STRIP táº¥t cáº£ x-forwarded-* headers Ä‘áº¿n                       â”‚
â”‚     â†’ SET headers Má»šI tá»« JWT token Ä‘Ã£ verify                       â”‚
â”‚                                                                     â”‚
â”‚  4. App nháº­n headers TRUSTED tá»« OAuth2-Proxy:                      â”‚
â”‚     x-forwarded-user: "gv1"      â† Tá»« JWT, khÃ´ng pháº£i user input  â”‚
â”‚     x-forwarded-groups: "giangvien"                                â”‚
â”‚                                                                     â”‚
â”‚  Káº¿t quáº£ attack:                                                    â”‚
â”‚  $ curl -H "x-forwarded-user: admin" .../api/giangvien             â”‚
â”‚  â†’ 302 Redirect to Keycloak (khÃ´ng cÃ³ session)                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3.4 ğŸ”¥ KhÃ³ khÄƒn #4: AWS Security Groups cho Kubernetes

### Váº¥n Ä‘á» gáº·p pháº£i:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ PODS KHÃ”NG THá»‚ COMMUNICATE QUA VPN                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Ban Ä‘áº§u Security Group chá»‰ cho phÃ©p:                              â”‚
â”‚  â€¢ SSH (22)                                                         â”‚
â”‚  â€¢ WireGuard (51820/UDP)                                           â”‚
â”‚                                                                     â”‚
â”‚  NhÆ°ng Kubernetes cáº§n nhiá»u hÆ¡n:                                   â”‚
â”‚  â€¢ Pod network: 10.42.0.0/16 (Flannel CIDR)                        â”‚
â”‚  â€¢ Service network: 10.43.0.0/16                                   â”‚
â”‚  â€¢ Node communication: 10.0.1.0/24, 10.200.0.0/24                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Giáº£i phÃ¡p trong Terraform:

```hcl
# Security Group cho AWS Workload
resource "aws_security_group" "workload" {
  name        = "zta-workload-sg"
  description = "Zero Trust - Only from WireGuard"
  vpc_id      = aws_vpc.main.id

  # Chá»‰ cho phÃ©p traffic tá»« WireGuard gateway
  ingress {
    from_port       = 0
    to_port         = 0
    protocol        = "-1"
    security_groups = [aws_security_group.wireguard.id]
  }

  # Pod network tá»« OpenStack
  ingress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = [
      "10.42.0.0/16",   # Flannel pod network
      "10.200.0.0/24",  # WireGuard tunnel
      "10.0.1.0/24"     # OpenStack node network
    ]
  }
}
```

**Zero Trust principle:** Deny by default, chá»‰ allow nhá»¯ng gÃ¬ cáº§n thiáº¿t.

---

## 3.5 ğŸ”¥ KhÃ³ khÄƒn #5: Keycloak Groups Claim cho RBAC

### Váº¥n Ä‘á» gáº·p pháº£i:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ OAUTH2-PROXY KHÃ”NG NHáº¬N ÄÆ¯á»¢C GROUPS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Máº·c Ä‘á»‹nh Keycloak KHÃ”NG include groups trong JWT token!           â”‚
â”‚                                                                     â”‚
â”‚  JWT Token ban Ä‘áº§u:                                                 â”‚
â”‚  {                                                                  â”‚
â”‚    "sub": "gv1",                                                   â”‚
â”‚    "email": "gv1@zta.local",                                       â”‚
â”‚    "preferred_username": "gv1"                                     â”‚
â”‚    // KHÃ”NG CÃ“ groups claim!                                       â”‚
â”‚  }                                                                  â”‚
â”‚                                                                     â”‚
â”‚  OAuth2-Proxy logs:                                                 â”‚
â”‚  [warn] no groups claim found in token                             â”‚
â”‚                                                                     â”‚
â”‚  x-forwarded-groups header = EMPTY                                 â”‚
â”‚  â†’ RBAC khÃ´ng hoáº¡t Ä‘á»™ng!                                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Giáº£i phÃ¡p: Cáº¥u hÃ¬nh Protocol Mapper trong Keycloak

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… Táº O PROTOCOL MAPPER CHO GROUPS                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Keycloak Admin â†’ Clients â†’ demo-app â†’ Client Scopes               â”‚
â”‚  â†’ demo-app-dedicated â†’ Mappers â†’ Add mapper                       â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Mapper Type: Group Membership                      â”‚           â”‚
â”‚  â”‚  Name: groups                                       â”‚           â”‚
â”‚  â”‚  Token Claim Name: groups                           â”‚           â”‚
â”‚  â”‚  Full group path: OFF                               â”‚           â”‚
â”‚  â”‚  Add to ID token: ON                                â”‚           â”‚
â”‚  â”‚  Add to access token: ON                            â”‚           â”‚
â”‚  â”‚  Add to userinfo: ON                                â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                     â”‚
â”‚  JWT Token sau khi cáº¥u hÃ¬nh:                                       â”‚
â”‚  {                                                                  â”‚
â”‚    "sub": "gv1",                                                   â”‚
â”‚    "email": "gv1@zta.local",                                       â”‚
â”‚    "preferred_username": "gv1",                                    â”‚
â”‚    "groups": ["giangvien"]    â† GROUPS ÄÃƒ CÃ“!                     â”‚
â”‚  }                                                                  â”‚
â”‚                                                                     â”‚
â”‚  x-forwarded-groups: giangvien                                     â”‚
â”‚  â†’ RBAC hoáº¡t Ä‘á»™ng!                                                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3.5 ğŸ†• OPA Policy Engine - Policy-as-Code

### Táº¡i sao cáº§n OPA?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OPA - OPEN POLICY AGENT (Policy Decision Point)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Váº¥n Ä‘á»: Authorization logic hardcoded trong application           â”‚
â”‚  â†’ KhÃ³ audit, khÃ³ thay Ä‘á»•i, khÃ³ version control                    â”‚
â”‚                                                                     â”‚
â”‚  Giáº£i phÃ¡p: OPA + Rego                                             â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ package zta.authz                                            â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚ role_permissions := {                                        â”‚   â”‚
â”‚  â”‚   "giangvien": ["/api/giangvien", "/api/sinhvien",          â”‚   â”‚
â”‚  â”‚                 "/api/tkb", "/api/me"],                      â”‚   â”‚
â”‚  â”‚   "sinhvien":  ["/api/sinhvien", "/api/tkb", "/api/me"]     â”‚   â”‚
â”‚  â”‚ }                                                            â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚ default allow := false  # Zero Trust - Deny by default      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚ allow if {                                                   â”‚   â”‚
â”‚  â”‚   some role, paths in role_permissions                      â”‚   â”‚
â”‚  â”‚   input.role == role                                        â”‚   â”‚
â”‚  â”‚   some path in paths                                        â”‚   â”‚
â”‚  â”‚   input.path == path                                        â”‚   â”‚
â”‚  â”‚ }                                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  Æ¯u Ä‘iá»ƒm:                                                           â”‚
â”‚  âœ… Policy-as-Code: git version control, review process           â”‚
â”‚  âœ… TÃ¡ch biá»‡t policy khá»i application code                        â”‚
â”‚  âœ… Audit trail: biáº¿t ai thay Ä‘á»•i policy khi nÃ o                   â”‚
â”‚  âœ… Default DENY: Zero Trust principle                             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3.6 ğŸ†• SPIFFE/SPIRE - Workload Identity

### Táº¡i sao cáº§n SPIFFE/SPIRE?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SPIFFE/SPIRE - WORKLOAD IDENTITY                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Váº¥n Ä‘á»: Trust dá»±a trÃªn network location                           â”‚
â”‚  â†’ "Service tá»« IP 10.0.1.x lÃ  trusted" = KHÃ”NG ZERO TRUST!         â”‚
â”‚                                                                     â”‚
â”‚  Giáº£i phÃ¡p: SPIFFE/SPIRE                                           â”‚
â”‚                                                                     â”‚
â”‚  SPIFFE ID format:                                                  â”‚
â”‚  spiffe://zta.local/ns/<namespace>/sa/<serviceaccount>             â”‚
â”‚                                                                     â”‚
â”‚  VÃ­ dá»¥:                                                             â”‚
â”‚  â€¢ spiffe://zta.local/ns/demo/sa/demo-app                          â”‚
â”‚  â€¢ spiffe://zta.local/ns/microservices/sa/tkb-service              â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      SPIRE SERVER                            â”‚   â”‚
â”‚  â”‚  â€¢ Trust Domain: zta.local                                   â”‚   â”‚
â”‚  â”‚  â€¢ CA TTL: 24h (short-lived certificates)                    â”‚   â”‚
â”‚  â”‚  â€¢ Issues SVIDs (SPIFFE Verifiable Identity Documents)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      SPIRE AGENT                             â”‚   â”‚
â”‚  â”‚  â€¢ Runs on each node (master, worker, aws-worker-1)         â”‚   â”‚
â”‚  â”‚  â€¢ Attests workloads before issuing certificates            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      WORKLOADS (Pods)                        â”‚   â”‚
â”‚  â”‚  â€¢ Receive X.509 certificates with SPIFFE ID in SAN         â”‚   â”‚
â”‚  â”‚  â€¢ Certificates auto-rotate after 24h                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  Æ¯u Ä‘iá»ƒm:                                                           â”‚
â”‚  âœ… Cryptographic identity, khÃ´ng dá»±a vÃ o IP/network               â”‚
â”‚  âœ… Short-lived certificates: giáº£m risk náº¿u bá»‹ compromise          â”‚
â”‚  âœ… Automatic rotation: khÃ´ng cáº§n manual renew                     â”‚
â”‚  âœ… Cross-platform: hoáº¡t Ä‘á»™ng trÃªn cáº£ OpenStack vÃ  AWS             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# PHáº¦N 4: NHá»®NG ÄIá»‚M Ná»”I Báº¬T Cá»¦A Äá»’ ÃN

## 4.1 âœ¨ Single Kubernetes Cluster Spanning 2 Clouds

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ÄIá»‚M Äáº¶C BIá»†T: UNIFIED CONTROL PLANE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  $ kubectl get nodes                                                â”‚
â”‚  NAME           STATUS   ROLES                  AGE                 â”‚
â”‚  master         Ready    control-plane,master   2d     (OpenStack) â”‚
â”‚  worker         Ready    <none>                 2d     (OpenStack) â”‚
â”‚  aws-worker-1   Ready    <none>                 1d     (AWS)       â”‚
â”‚                                                                     â”‚
â”‚  Æ¯u Ä‘iá»ƒm:                                                           â”‚
â”‚  âœ… Quáº£n lÃ½ táº­p trung tá»« 1 kubectl                                 â”‚
â”‚  âœ… Scheduling tá»± Ä‘á»™ng dá»±a trÃªn nodeSelector                       â”‚
â”‚  âœ… KhÃ´ng cáº§n federation phá»©c táº¡p                                  â”‚
â”‚  âœ… Secrets, ConfigMaps chia sáº» giá»¯a 2 cloud                       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4.2 âœ¨ True Microservices vá»›i Cross-Cloud Communication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/tkb - MICROSERVICE THá»°C Sá»° TRÃŠN AWS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Request flow:                                                      â”‚
â”‚                                                                     â”‚
â”‚  Browser (Vietnam)                                                  â”‚
â”‚      â”‚                                                              â”‚
â”‚      â–¼                                                              â”‚
â”‚  OpenStack (Demo-App)                                               â”‚
â”‚      â”‚                                                              â”‚
â”‚      â”‚ WireGuard VPN (encrypted)                                    â”‚
â”‚      â”‚ ~45ms latency                                                â”‚
â”‚      â–¼                                                              â”‚
â”‚  AWS Singapore (TKB-Service)                                        â”‚
â”‚      â”‚                                                              â”‚
â”‚      â”‚ Return JSON based on role                                    â”‚
â”‚      â–¼                                                              â”‚
â”‚  Response back to user                                              â”‚
â”‚                                                                     â”‚
â”‚  Chá»©ng minh:                                                        â”‚
â”‚  {                                                                  â”‚
â”‚    "location": "AWS Singapore",  â† Proof cháº¡y trÃªn AWS             â”‚
â”‚    "schedule": { ... }                                              â”‚
â”‚  }                                                                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4.3 âœ¨ Defense in Depth - Nhiá»u lá»›p báº£o vá»‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    8 Lá»šP Báº¢O Vá»† ZERO TRUST                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Layer 1: Network Perimeter                                         â”‚
â”‚           â””â”€â”€ Istio Gateway (single entry point)                   â”‚
â”‚                                                                     â”‚
â”‚  Layer 2: Authentication (AuthN)                                    â”‚
â”‚           â””â”€â”€ OAuth2-Proxy + Keycloak OIDC                         â”‚
â”‚                                                                     â”‚
â”‚  Layer 3: Authorization (AuthZ) - NEW!                              â”‚
â”‚           â””â”€â”€ OPA Policy Engine (Rego policies)                    â”‚
â”‚           â””â”€â”€ Policy-as-Code, default DENY                         â”‚
â”‚                                                                     â”‚
â”‚  Layer 4: Workload Identity - NEW!                                  â”‚
â”‚           â””â”€â”€ SPIFFE/SPIRE (Trust Domain: zta.local)              â”‚
â”‚           â””â”€â”€ Short-lived certificates (24h TTL)                   â”‚
â”‚                                                                     â”‚
â”‚  Layer 5: Transport Encryption                                      â”‚
â”‚           â””â”€â”€ WireGuard VPN (cross-cloud)                          â”‚
â”‚                                                                     â”‚
â”‚  Layer 6: Service Mesh                                              â”‚
â”‚           â””â”€â”€ Istio mTLS (pod-to-pod) with SPIFFE IDs              â”‚
â”‚                                                                     â”‚
â”‚  Layer 7: Network Segmentation                                      â”‚
â”‚           â””â”€â”€ AWS Security Groups (deny by default)                â”‚
â”‚           â””â”€â”€ Kubernetes Network Policies                          â”‚
â”‚                                                                     â”‚
â”‚  Layer 8: Monitoring & Detection                                    â”‚
â”‚           â””â”€â”€ Prometheus metrics                                   â”‚
â”‚           â””â”€â”€ Grafana dashboards                                   â”‚
â”‚           â””â”€â”€ Loki logs                                            â”‚
â”‚           â””â”€â”€ AWS VPC Flow Logs                                    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4.4 âœ¨ Role-Based Data Response

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CÃ™NG 1 API, DATA KHÃC NHAU THEO ROLE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  GET /api/tkb                                                       â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  User: gv1          â”‚    â”‚  User: sv1          â”‚                â”‚
â”‚  â”‚  Role: giangvien    â”‚    â”‚  Role: sinhvien     â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚  Response:          â”‚    â”‚  Response:          â”‚                â”‚
â”‚  â”‚  {                  â”‚    â”‚  {                  â”‚                â”‚
â”‚  â”‚    "role": "gv",    â”‚    â”‚    "role": "sv",    â”‚                â”‚
â”‚  â”‚    "schedule": {    â”‚    â”‚    "schedule": {    â”‚                â”‚
â”‚  â”‚      "monday": {    â”‚    â”‚      "monday": {    â”‚                â”‚
â”‚  â”‚        "subject":   â”‚    â”‚        "subject":   â”‚                â”‚
â”‚  â”‚          "Python",  â”‚    â”‚          "Python",  â”‚                â”‚
â”‚  â”‚        "room":      â”‚    â”‚        "teacher":   â”‚                â”‚
â”‚  â”‚          "A101",    â”‚    â”‚          "Ng.V.A",  â”‚                â”‚
â”‚  â”‚        "class":     â”‚    â”‚      }              â”‚                â”‚
â”‚  â”‚          "CNTT01"   â”‚    â”‚    }                â”‚                â”‚
â”‚  â”‚      }              â”‚    â”‚  }                  â”‚                â”‚
â”‚  â”‚    }                â”‚    â”‚                     â”‚                â”‚
â”‚  â”‚  }                  â”‚    â”‚                     â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                     â”‚
â”‚  GV tháº¥y: Lá»›p, phÃ²ng, nhÃ³m SV     SV tháº¥y: MÃ´n, tÃªn giáº£ng viÃªn    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# PHáº¦N 5: DEMO COMMANDS

## 5.1 Chá»©ng minh Hybrid Cloud Cluster

```bash
# Hiá»ƒn thá»‹ nodes tá»« 2 cloud
kubectl get nodes -o wide

# Káº¿t quáº£:
# NAME           STATUS   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE
# master         Ready    10.0.1.185     <none>        Ubuntu 22.04  (OpenStack)
# worker         Ready    10.0.1.65      <none>        Ubuntu 22.04  (OpenStack)  
# aws-worker-1   Ready    10.200.0.1     <none>        Ubuntu 22.04  (AWS via VPN)
```

## 5.2 Chá»©ng minh VPN Connectivity

```bash
# Ping AWS qua WireGuard
ping -c 3 10.200.0.1
# 64 bytes from 10.200.0.1: time=45.2 ms

# Kiá»ƒm tra VPN status
sudo wg show
# interface: wg0
# peer: F1VpZHOB...
#   endpoint: 18.143.117.69:51820
#   latest handshake: 15 seconds ago
#   transfer: 2.45 MiB received, 1.23 MiB sent
```

## 5.3 Chá»©ng minh TKB cháº¡y trÃªn AWS

```bash
# Xem pod Ä‘ang cháº¡y á»Ÿ node nÃ o
kubectl get pods -n microservices -o wide
# NAME              NODE           
# tkb-service-xxx   aws-worker-1   â† Cháº¡y trÃªn AWS!

# Gá»i health check
curl -s http://10.200.0.1:30080/health | jq
# {
#   "status": "healthy",
#   "location": "AWS Singapore"  â† Proof!
# }
```

## 5.4 Chá»©ng minh Attack Prevention

```bash
# Header injection attack
curl -v -H "x-forwarded-user: admin" \
        -H "x-forwarded-groups: giangvien" \
        http://app.172.10.0.190.nip.io:31691/api/giangvien

# Káº¿t quáº£: 302 Redirect to Keycloak (khÃ´ng bypass Ä‘Æ°á»£c)
```

---

# PHáº¦N 6: Káº¾T LUáº¬N

## 6.1 Nhá»¯ng gÃ¬ Ä‘Ã£ Ä‘áº¡t Ä‘Æ°á»£c

| Má»¥c tiÃªu | Káº¿t quáº£ |
|----------|---------|
| Zero Trust Authentication | âœ… Keycloak OIDC + OAuth2-Proxy |
| Zero Trust Authorization | âœ… OPA Policy Engine (Rego) |
| Workload Identity | âœ… SPIFFE/SPIRE (Trust Domain: zta.local) |
| Hybrid Cloud | âœ… OpenStack + AWS qua WireGuard |
| Microservices | âœ… TKB Service trÃªn AWS |
| Service Mesh | âœ… Istio vá»›i mTLS + SPIFFE IDs |
| Policy-as-Code | âœ… Rego policies (auditable, version control) |
| Short-lived Credentials | âœ… 24h TTL, auto-rotation |
| Infrastructure as Code | âœ… Terraform cho AWS |
| Monitoring | âœ… Prometheus + Grafana + Loki |
| Attack Prevention | âœ… Header injection blocked |

## 6.2 BÃ i há»c rÃºt ra

1. **WireGuard IP cho cross-cloud K8s**: Sá»­ dá»¥ng `--node-ip` lÃ  VPN IP, khÃ´ng pháº£i private IP
2. **Istio khÃ´ng pháº£i lÃºc nÃ o cÅ©ng cáº§n**: NodePort lÃ  giáº£i phÃ¡p pragmatic cho hybrid cloud
3. **Keycloak Protocol Mapper**: Cáº§n cáº¥u hÃ¬nh Ä‘á»ƒ include groups trong JWT
4. **Security Groups**: Deny by default, chá»‰ allow pod network khi cáº§n
5. **Defense in Depth**: Nhiá»u lá»›p báº£o vá»‡ tá»‘t hÆ¡n 1 lá»›p máº¡nh

## 6.3 Táº¡i sao Ä‘Ã¢y lÃ  Zero Trust thá»±c sá»±?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚   "KhÃ´ng cÃ³ gÃ¬ Ä‘Æ°á»£c tin tÆ°á»Ÿng máº·c Ä‘á»‹nh"                            â”‚
â”‚                                                                     â”‚
â”‚   â€¢ Request khÃ´ng cÃ³ session â†’ Redirect to Keycloak                â”‚
â”‚   â€¢ User khÃ´ng cÃ³ role â†’ OPA DENY (403 Forbidden)                  â”‚
â”‚   â€¢ Traffic cross-cloud â†’ Encrypted vá»›i WireGuard                  â”‚
â”‚   â€¢ Pod-to-pod â†’ mTLS vá»›i Istio + SPIFFE IDs                       â”‚
â”‚   â€¢ Fake headers â†’ Stripped by OAuth2-Proxy                        â”‚
â”‚   â€¢ Fake JWT â†’ Rejected (signature verification)                   â”‚
â”‚   â€¢ Workload identity â†’ SPIRE short-lived certs (24h)              â”‚
â”‚   â€¢ Authorization â†’ OPA Policy-as-Code (auditable)                 â”‚
â”‚                                                                     â”‚
â”‚   ÄÃ‚Y LÃ€ ZERO TRUST, KHÃ”NG PHáº¢I CHá»ˆ LÃ€ TÃŠN Gá»ŒI!                   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# Cáº¢M Æ N THáº¦Y/CÃ” ÄÃƒ Láº®NG NGHE!

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                    â•‘
â•‘     ğŸ” ZERO TRUST HYBRID CLOUD - HOÃ€N THÃ€NH!                      â•‘
â•‘                                                                    â•‘
â•‘     "Never Trust, Always Verify"                                   â•‘
â•‘                                                                    â•‘
â•‘     âœ… Keycloak (AuthN) + OPA (AuthZ)                             â•‘
â•‘     âœ… SPIFFE/SPIRE (Workload Identity)                           â•‘
â•‘     âœ… Istio mTLS + WireGuard VPN                                 â•‘
â•‘     âœ… Hybrid Cloud: OpenStack + AWS                              â•‘
â•‘     âœ… Policy-as-Code (Rego)                                      â•‘
â•‘     âœ… Short-lived Certificates (24h)                             â•‘
â•‘                                                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```
