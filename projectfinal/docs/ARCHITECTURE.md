# 🏗️ KIẾN TRÚC ZERO TRUST HYBRID CLOUD

## 📋 Tổng quan Đồ án

Đồ án triển khai **Zero Trust Architecture (ZTA)** trên môi trường **Hybrid Cloud** kết hợp:
- **OpenStack** (On-Premises Private Cloud)
- **AWS** (Public Cloud - Singapore Region)

### 🔗 Phương thức kết nối Hybrid Cloud:

| Phương thức | Mô tả | Sử dụng |
|-------------|-------|---------|
| **AWS Direct Connect** | Kết nối vật lý chuyên dụng | Production (Enterprise) |
| **AWS Transit Gateway** | Hub kết nối nhiều VPC/VPN | Scalable multi-VPC |
| **Site-to-Site VPN** | VPN managed by AWS | Backup/Fallback |
| **WireGuard VPN** | Point-to-point VPN | Lab/Demo environment |

> **Lưu ý**: Trong môi trường lab, sử dụng WireGuard VPN. Trong production enterprise, nên sử dụng **AWS Direct Connect + Transit Gateway**.

### 🔐 Các thành phần bảo mật Zero Trust:

| Component | Chức năng | Vị trí |
|-----------|-----------|--------|
| **Keycloak** | Identity Provider (OIDC/OAuth2) | OpenStack |
| **OAuth2-Proxy** | Authentication Gateway | OpenStack |
| **OPA (Open Policy Agent)** | Policy Decision Point (PDP) - Authorization | OpenStack |
| **SPIFFE/SPIRE** | Workload Identity & mTLS Certificates | OpenStack |
| **Istio Service Mesh** | mTLS, Traffic Management, Observability | All Nodes |

---

## 🌐 SƠ ĐỒ KIẾN TRÚC MẠNG CHI TIẾT (L2/L3 + Overlay/Underlay)

### 1. Kiến trúc tổng quan - Physical & Logical View

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              INTERNET                                                            │
│                                          (Public Network)                                                        │
│                                                 │                                                                │
│                                    ┌────────────┴────────────┐                                                   │
│                                    │                         │                                                   │
│                                    ▼                         ▼                                                   │
│   ╔═════════════════════════════════════════════╗   ╔═════════════════════════════════════════════════════════╗ │
│   ║           ON-PREMISES DATA CENTER           ║   ║                    AWS CLOUD                             ║ │
│   ║               (OpenStack)                   ║   ║              (ap-southeast-1)                            ║ │
│   ╚═════════════════════════════════════════════╝   ╚═════════════════════════════════════════════════════════╝ │
│                       │                                                     │                                    │
│                       │                                                     │                                    │
│   ┌───────────────────┴─────────────────────┐       ┌──────────────────────┴────────────────────────────────┐   │
│   │                                         │       │                                                        │   │
│   │  ┌─────────────────────────────────┐   │       │   ┌────────────────────────────────────────────────┐   │   │
│   │  │     PHYSICAL LAYER (L1/L2)      │   │       │   │          AWS DIRECT CONNECT / VPN              │   │   │
│   │  ├─────────────────────────────────┤   │       │   ├────────────────────────────────────────────────┤   │   │
│   │  │                                 │   │       │   │                                                │   │   │
│   │  │  ┌─────────┐    ┌─────────┐    │   │       │   │  ┌──────────────┐    ┌──────────────────────┐  │   │   │
│   │  │  │Physical │    │Physical │    │   │       │   │  │ Direct       │    │ Virtual Private      │  │   │   │
│   │  │  │Server 1 │    │Server 2 │    │   │       │   │  │ Connect      │    │ Gateway (VGW)        │  │   │   │
│   │  │  │(Compute)│    │(Compute)│    │   │       │   │  │ Location     │    │                      │  │   │   │
│   │  │  └────┬────┘    └────┬────┘    │   │       │   │  │ (DX Gateway) │    │ ┌──────────────────┐ │  │   │   │
│   │  │       │              │         │   │       │   │  └──────┬───────┘    │ │ Transit Gateway  │ │  │   │   │
│   │  │       └──────┬───────┘         │   │       │   │         │            │ │ (Hub for VPCs)   │ │  │   │   │
│   │  │              │                 │   │       │   │         │            │ └────────┬─────────┘ │  │   │   │
│   │  │              ▼                 │   │       │   │         │            │          │           │  │   │   │
│   │  │  ┌───────────────────────┐     │   │       │   │         │            └──────────┼───────────┘  │   │   │
│   │  │  │   Physical Switch     │     │   │◄──────┼───┼─────────┴─────────────────────────────────────►│   │   │
│   │  │  │   (L2 - ToR Switch)   │     │   │  DX   │   │         1-10 Gbps dedicated                    │   │   │
│   │  │  │   VLAN Trunking       │     │   │  or   │   │         Low latency (<5ms)                     │   │   │
│   │  │  └───────────┬───────────┘     │   │  VPN  │   │                                                │   │   │
│   │  │              │                 │   │       │   └────────────────────────────────────────────────┘   │   │
│   │  └──────────────┼─────────────────┘   │       │                                                        │   │
│   │                 │                     │       │                                                        │   │
│   │  ┌──────────────┼─────────────────┐   │       │   ┌────────────────────────────────────────────────┐   │   │
│   │  │   NETWORK LAYER (L3 - Router)  │   │       │   │              AWS VPC LAYER                     │   │   │
│   │  ├──────────────┼─────────────────┤   │       │   ├────────────────────────────────────────────────┤   │   │
│   │  │              ▼                 │   │       │   │                                                │   │   │
│   │  │  ┌───────────────────────┐     │   │       │   │   VPC CIDR: 10.100.0.0/16                      │   │   │
│   │  │  │    Core Router        │     │   │       │   │                                                │   │   │
│   │  │  │  (OpenStack Neutron)  │     │   │       │   │   ┌─────────────────┐  ┌─────────────────┐     │   │   │
│   │  │  │                       │     │   │       │   │   │ Public Subnet   │  │ Private Subnet  │     │   │   │
│   │  │  │  Gateway: 172.10.0.1  │     │   │       │   │   │ 10.100.1.0/24   │  │ 10.100.2.0/24   │     │   │   │
│   │  │  │  NAT: Enabled         │     │   │       │   │   │                 │  │                 │     │   │   │
│   │  │  └───────────────────────┘     │   │       │   │   │ Internet GW     │  │ NAT Gateway     │     │   │   │
│   │  │              │                 │   │       │   │   │ Route Table     │  │ Route Table     │     │   │   │
│   │  │              │                 │   │       │   │   └────────┬────────┘  └────────┬────────┘     │   │   │
│   │  └──────────────┼─────────────────┘   │       │   │            │                    │              │   │   │
│   │                 │                     │       │   └────────────┼────────────────────┼──────────────┘   │   │
│   │                 │                     │       │                │                    │                  │   │
│   └─────────────────┼─────────────────────┘       └────────────────┼────────────────────┼──────────────────┘   │
│                     │                                              │                    │                      │
└─────────────────────┼──────────────────────────────────────────────┼────────────────────┼──────────────────────┘
                      │                                              │                    │
                      │              UNDERLAY NETWORK                │                    │
                      │         (Physical/Cloud Infrastructure)      │                    │
                      │                                              │                    │
```

### 2. Chi tiết Overlay vs Underlay Network

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    NETWORK LAYERS: UNDERLAY vs OVERLAY                                          │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                 │
│  ╔═══════════════════════════════════════════════════════════════════════════════════════════════════════════╗ │
│  ║                                         OVERLAY NETWORK                                                    ║ │
│  ║                              (Virtual/Logical - Kubernetes & Istio)                                        ║ │
│  ╠═══════════════════════════════════════════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                                                           ║ │
│  ║   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ ║ │
│  ║   │                           KUBERNETES OVERLAY (Flannel VXLAN)                                        │ ║ │
│  ║   │                                                                                                     │ ║ │
│  ║   │   Pod Network: 10.42.0.0/16                    Service Network: 10.43.0.0/16                       │ ║ │
│  ║   │                                                                                                     │ ║ │
│  ║   │   ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐                    │ ║ │
│  ║   │   │  Master Node        │    │  Worker Node        │    │  AWS Worker         │                    │ ║ │
│  ║   │   │  Pod CIDR:          │    │  Pod CIDR:          │    │  Pod CIDR:          │                    │ ║ │
│  ║   │   │  10.42.0.0/24       │    │  10.42.1.0/24       │    │  10.42.3.0/24       │                    │ ║ │
│  ║   │   │                     │    │                     │    │                     │                    │ ║ │
│  ║   │   │  ┌───────────────┐  │    │  ┌───────────────┐  │    │  ┌───────────────┐  │                    │ ║ │
│  ║   │   │  │ demo-app      │  │    │  │ keycloak      │  │    │  │ tkb-service   │  │                    │ ║ │
│  ║   │   │  │ 10.42.0.50    │  │    │  │ 10.42.1.20    │  │    │  │ 10.42.3.10    │  │                    │ ║ │
│  ║   │   │  └───────────────┘  │    │  └───────────────┘  │    │  └───────────────┘  │                    │ ║ │
│  ║   │   │  ┌───────────────┐  │    │  ┌───────────────┐  │    │                     │                    │ ║ │
│  ║   │   │  │ oauth2-proxy  │  │    │  │ prometheus    │  │    │                     │                    │ ║ │
│  ║   │   │  │ 10.42.0.51    │  │    │  │ 10.42.1.21    │  │    │                     │                    │ ║ │
│  ║   │   │  └───────────────┘  │    │  └───────────────┘  │    │                     │                    │ ║ │
│  ║   │   └─────────┬───────────┘    └─────────┬───────────┘    └─────────┬───────────┘                    │ ║ │
│  ║   │             │                          │                          │                                 │ ║ │
│  ║   │             │     VXLAN Tunnel (VNI 1) │                          │                                 │ ║ │
│  ║   │             └──────────────────────────┴──────────────────────────┘                                 │ ║ │
│  ║   │                                        │                                                            │ ║ │
│  ║   └────────────────────────────────────────┼────────────────────────────────────────────────────────────┘ ║ │
│  ║                                            │                                                              ║ │
│  ║   ┌────────────────────────────────────────┼────────────────────────────────────────────────────────────┐ ║ │
│  ║   │                        ISTIO SERVICE MESH OVERLAY (mTLS)                                            │ ║ │
│  ║   │                                        │                                                            │ ║ │
│  ║   │   Envoy Sidecar Proxies communicate via mTLS                                                        │ ║ │
│  ║   │   SPIFFE IDs: spiffe://cluster.local/ns/{ns}/sa/{sa}                                                │ ║ │
│  ║   │                                        │                                                            │ ║ │
│  ║   │   demo-app ═══mTLS═══► oauth2-proxy ═══mTLS═══► keycloak                                            │ ║ │
│  ║   │      │                                                                                              │ ║ │
│  ║   │      └═══════════mTLS over VPN═══════════► tkb-service (AWS)                                        │ ║ │
│  ║   │                                                                                                     │ ║ │
│  ║   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ ║ │
│  ║                                                                                                           ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════════════════════════════════════╝ │
│                                                    │                                                            │
│                                                    │ Encapsulated in                                            │
│                                                    ▼                                                            │
│  ╔═══════════════════════════════════════════════════════════════════════════════════════════════════════════╗ │
│  ║                                         UNDERLAY NETWORK                                                   ║ │
│  ║                                    (Physical Infrastructure)                                               ║ │
│  ╠═══════════════════════════════════════════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                                                           ║ │
│  ║   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ ║ │
│  ║   │                              OPENSTACK NETWORK (Neutron)                                            │ ║ │
│  ║   │                                                                                                     │ ║ │
│  ║   │   Provider Network: 172.10.0.0/24 (External/Floating IPs)                                          │ ║ │
│  ║   │   Tenant Network:   10.0.1.0/24   (Internal VM Network)                                            │ ║ │
│  ║   │                                                                                                     │ ║ │
│  ║   │   ┌──────────────┐         ┌──────────────┐         ┌──────────────────────────────────────────┐   │ ║ │
│  ║   │   │   Master VM  │         │   Worker VM  │         │            VPN Tunnel                    │   │ ║ │
│  ║   │   │              │         │              │         │                                          │   │ ║ │
│  ║   │   │ eth0:        │         │ eth0:        │         │  WireGuard / AWS Site-to-Site VPN       │   │ ║ │
│  ║   │   │ 10.0.1.185   │         │ 10.0.1.65    │         │  or AWS Direct Connect                  │   │ ║ │
│  ║   │   │              │         │              │         │                                          │   │ ║ │
│  ║   │   │ Floating IP: │         │ Floating IP: │         │  Tunnel IP: 10.200.0.2 ◄───────────────►│   │ ║ │
│  ║   │   │ 172.10.0.190 │         │ 172.10.0.xxx │         │  AWS Tunnel: 10.200.0.1                  │   │ ║ │
│  ║   │   └──────────────┘         └──────────────┘         │                                          │   │ ║ │
│  ║   │          │                        │                 │  Encryption: ChaCha20/IPSec              │   │ ║ │
│  ║   │          │                        │                 │  Routing: BGP (Direct Connect)           │   │ ║ │
│  ║   │          └────────────────────────┘                 │           or Static (VPN)                │   │ ║ │
│  ║   │                     │                               └──────────────────────────────────────────┘   │ ║ │
│  ║   │                     │                                                  │                           │ ║ │
│  ║   └─────────────────────┼──────────────────────────────────────────────────┼───────────────────────────┘ ║ │
│  ║                         │                                                  │                             ║ │
│  ║   ┌─────────────────────┼──────────────────────────────────────────────────┼───────────────────────────┐ ║ │
│  ║   │                     │           AWS INFRASTRUCTURE                     │                           │ ║ │
│  ║   │                     │                                                  │                           │ ║ │
│  ║   │                     │         ┌────────────────────────────────────────┤                           │ ║ │
│  ║   │                     │         │                                        │                           │ ║ │
│  ║   │                     │         ▼                                        ▼                           │ ║ │
│  ║   │                     │    ┌──────────────┐                    ┌──────────────┐                      │ ║ │
│  ║   │                     │    │ VPN Gateway  │  ◄── or ──►        │ AWS Worker   │                      │ ║ │
│  ║   │                     │    │ / Direct     │                    │ Node         │                      │ ║ │
│  ║   │                     │    │   Connect    │                    │              │                      │ ║ │
│  ║   │                     │    │              │                    │ Private IP:  │                      │ ║ │
│  ║   │                     │    │ Public IP:   │                    │ 10.100.2.50  │                      │ ║ │
│  ║   │                     │    │ 18.143.x.x   │                    │              │                      │ ║ │
│  ║   │                     │    │              │                    │ K3s Agent    │                      │ ║ │
│  ║   │                     │    │ Tunnel IP:   │                    │ joined via   │                      │ ║ │
│  ║   │                     │    │ 10.200.0.1   │                    │ VPN/DX       │                      │ ║ │
│  ║   │                     │    └──────────────┘                    └──────────────┘                      │ ║ │
│  ║   │                     │                                                                              │ ║ │
│  ║   └─────────────────────┴──────────────────────────────────────────────────────────────────────────────┘ ║ │
│  ║                                                                                                           ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🌐 HYBRID CLOUD NETWORK TOPOLOGY - CHI TIẾT L2/L3/OVERLAY/UNDERLAY

### Sơ đồ tổng quan: Kết nối OpenStack ↔ AWS qua các tầng mạng

```
┌══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════┐
║                                            HYBRID CLOUD NETWORK TOPOLOGY                                                                  ║
║                                     OpenStack (On-Premises) ←──────────→ AWS (Public Cloud)                                               ║
╠══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                                                                          ║
║   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  ║
║   ┃                                              LAYER 7 - APPLICATION LAYER                                                          ┃  ║
║   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫  ║
║   ┃                                                                                                                                    ┃  ║
║   ┃   ┌─────────────────────────────────────────────────┐              ┌─────────────────────────────────────────────────┐             ┃  ║
║   ┃   │              OPENSTACK APPS                     │              │                   AWS APPS                      │             ┃  ║
║   ┃   │                                                 │              │                                                 │             ┃  ║
║   ┃   │  ┌─────────┐ ┌─────────┐ ┌─────────┐           │              │           ┌─────────────────────────────┐       │             ┃  ║
║   ┃   │  │Keycloak │ │OAuth2-  │ │Demo-App │           │   HTTP/gRPC  │           │      TKB-Service            │       │             ┃  ║
║   ┃   │  │  OIDC   │ │ Proxy   │ │ FastAPI │ ◄─────────┼──────────────┼──────────►│      (Node.js/Express)      │       │             ┃  ║
║   ┃   │  │ :8080   │ │ :4180   │ │ :8000   │           │   over VPN   │           │      :3000 (NodePort 30080) │       │             ┃  ║
║   ┃   │  └─────────┘ └─────────┘ └─────────┘           │              │           └─────────────────────────────┘       │             ┃  ║
║   ┃   │                                                 │              │                                                 │             ┃  ║
║   ┃   └─────────────────────────────────────────────────┘              └─────────────────────────────────────────────────┘             ┃  ║
║   ┃                                                                                                                                    ┃  ║
║   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  ║
║                                                              │                                                                           ║
║   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  ║
║   ┃                                        OVERLAY NETWORK - SERVICE MESH (Istio mTLS)                                                ┃  ║
║   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫  ║
║   ┃                                                                                                                                    ┃  ║
║   ┃    Envoy Sidecar Proxy ◄════════════ mTLS (SPIFFE ID) ════════════► Envoy Sidecar Proxy                                           ┃  ║
║   ┃                                                                                                                                    ┃  ║
║   ┃    SPIFFE ID: spiffe://cluster.local/ns/demo/sa/demo-app  ↔  spiffe://cluster.local/ns/microservices/sa/tkb-service              ┃  ║
║   ┃                                                                                                                                    ┃  ║
║   ┃    ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  ┃  ║
║   ┃    │ Istio Service Mesh Components:                                                                                            │  ┃  ║
║   ┃    │  • Istiod (Control Plane): xDS API, Certificate Distribution                                                              │  ┃  ║
║   ┃    │  • Envoy Proxy (Data Plane): Sidecar injection, Traffic interception                                                      │  ┃  ║
║   ┃    │  • mTLS Mode: STRICT (all service-to-service traffic encrypted)                                                           │  ┃  ║
║   ┃    │  • PeerAuthentication: Validates SPIFFE certificates                                                                      │  ┃  ║
║   ┃    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  ┃  ║
║   ┃                                                                                                                                    ┃  ║
║   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  ║
║                                                              │                                                                           ║
║   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  ║
║   ┃                                         OVERLAY NETWORK - KUBERNETES CNI (Flannel VXLAN)                                          ┃  ║
║   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫  ║
║   ┃                                                                                                                                    ┃  ║
║   ┃   ┌────────────────────────────────────────────┐                    ┌────────────────────────────────────────────┐                ┃  ║
║   ┃   │         OPENSTACK K3s NODES                │                    │              AWS K3s NODE                  │                ┃  ║
║   ┃   │                                            │                    │                                            │                ┃  ║
║   ┃   │  ┌──────────────────┐ ┌──────────────────┐ │     VXLAN VNI 1    │  ┌──────────────────────────────────────┐  │                ┃  ║
║   ┃   │  │   Master Node    │ │   Worker Node    │ │   ════════════════ │  │         aws-worker-1                 │  │                ┃  ║
║   ┃   │  │  Pod CIDR:       │ │  Pod CIDR:       │ │   UDP Port 8472    │  │        Pod CIDR:                     │  │                ┃  ║
║   ┃   │  │  10.42.0.0/24    │ │  10.42.1.0/24    │ │   Encapsulated     │  │        10.42.3.0/24                  │  │                ┃  ║
║   ┃   │  │                  │ │                  │ │                    │  │                                      │  │                ┃  ║
║   ┃   │  │  flannel.1:      │ │  flannel.1:      │ │                    │  │  flannel.1:                          │  │                ┃  ║
║   ┃   │  │  10.42.0.0       │ │  10.42.1.0       │ │                    │  │  10.42.3.0                           │  │                ┃  ║
║   ┃   │  │  (VTEP)          │ │  (VTEP)          │ │                    │  │  (VTEP)                              │  │                ┃  ║
║   ┃   │  └──────────────────┘ └──────────────────┘ │                    │  └──────────────────────────────────────┘  │                ┃  ║
║   ┃   │                                            │                    │                                            │                ┃  ║
║   ┃   │  Service Network: 10.43.0.0/16             │                    │  Service Network: 10.43.0.0/16             │                ┃  ║
║   ┃   │  CoreDNS: 10.43.0.10                       │                    │  (Shared across cluster)                   │                ┃  ║
║   ┃   └────────────────────────────────────────────┘                    └────────────────────────────────────────────┘                ┃  ║
║   ┃                                                                                                                                    ┃  ║
║   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  ║
║                                                              │                                                                           ║
║   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  ║
║   ┃                                              OVERLAY NETWORK - VPN TUNNEL (WireGuard)                                             ┃  ║
║   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫  ║
║   ┃                                                                                                                                    ┃  ║
║   ┃   ┌────────────────────────────────────────────┐                    ┌────────────────────────────────────────────┐                ┃  ║
║   ┃   │       OPENSTACK WireGuard Gateway          │                    │          AWS WireGuard Gateway             │                ┃  ║
║   ┃   │                                            │                    │                                            │                ┃  ║
║   ┃   │   Interface: wg0                           │   WireGuard VPN    │   Interface: wg0                           │                ┃  ║
║   ┃   │   Tunnel IP: 10.200.0.2/24                 │ ◄════════════════► │   Tunnel IP: 10.200.0.1/24                 │                ┃  ║
║   ┃   │   Listen Port: 51820/UDP                   │   ChaCha20-Poly1305│   Listen Port: 51820/UDP                   │                ┃  ║
║   ┃   │                                            │   Encrypted        │                                            │                ┃  ║
║   ┃   │   AllowedIPs:                              │                    │   AllowedIPs:                              │                ┃  ║
║   ┃   │   - 10.100.0.0/16 (AWS VPC)               │                    │   - 172.10.0.0/24 (OpenStack External)     │                ┃  ║
║   ┃   │   - 10.200.0.1/32 (AWS Tunnel)            │                    │   - 10.0.1.0/24 (OpenStack Internal)       │                ┃  ║
║   ┃   │   - 10.42.3.0/24 (AWS Pod CIDR)           │                    │   - 10.42.0.0/24, 10.42.1.0/24 (Pod CIDRs) │                ┃  ║
║   ┃   │                                            │                    │   - 10.200.0.2/32 (OpenStack Tunnel)       │                ┃  ║
║   ┃   │   PostUp: iptables NAT MASQUERADE          │                    │   PostUp: iptables NAT MASQUERADE          │                ┃  ║
║   ┃   └────────────────────────────────────────────┘                    └────────────────────────────────────────────┘                ┃  ║
║   ┃                                                                                                                                    ┃  ║
║   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  ║
║                                                              │                                                                           ║
║   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  ║
║   ┃                                             LAYER 3 - NETWORK/ROUTING LAYER                                                       ┃  ║
║   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫  ║
║   ┃                                                                                                                                    ┃  ║
║   ┃   ┌────────────────────────────────────────────────────────────┐    ┌────────────────────────────────────────────────────────────┐┃  ║
║   ┃   │                  OPENSTACK NEUTRON ROUTER                  │    │                    AWS VPC ROUTER                          │┃  ║
║   ┃   │                                                            │    │                                                            │┃  ║
║   ┃   │   ┌──────────────────────────────────────────────────────┐ │    │   ┌──────────────────────────────────────────────────────┐ │┃  ║
║   ┃   │   │                    ROUTING TABLE                     │ │    │   │                    ROUTING TABLE                     │ │┃  ║
║   ┃   │   ├──────────────────────────────────────────────────────┤ │    │   ├──────────────────────────────────────────────────────┤ │┃  ║
║   ┃   │   │ Destination        │ Next Hop         │ Interface    │ │    │   │ Destination        │ Next Hop         │ Interface    │ │┃  ║
║   ┃   │   ├────────────────────┼──────────────────┼──────────────┤ │    │   ├────────────────────┼──────────────────┼──────────────┤ │┃  ║
║   ┃   │   │ 0.0.0.0/0          │ 172.10.0.1       │ external     │ │    │   │ 0.0.0.0/0          │ igw-xxxxx        │ igw          │ │┃  ║
║   ┃   │   │ 10.0.1.0/24        │ local            │ internal     │ │    │   │ 10.100.0.0/16      │ local            │ local        │ │┃  ║
║   ┃   │   │ 172.10.0.0/24      │ local            │ external     │ │    │   │ 10.100.1.0/24      │ local            │ public-sub   │ │┃  ║
║   ┃   │   │ 10.100.0.0/16      │ 10.200.0.1       │ wg0          │ │    │   │ 10.100.2.0/24      │ local            │ private-sub  │ │┃  ║
║   ┃   │   │ 10.42.3.0/24       │ 10.200.0.1       │ wg0          │ │    │   │ 172.10.0.0/24      │ 10.200.0.2       │ wg0 (eni)    │ │┃  ║
║   ┃   │   │ 10.200.0.0/24      │ local            │ wg0          │ │    │   │ 10.42.0.0/24       │ 10.200.0.2       │ wg0 (eni)    │ │┃  ║
║   ┃   │   └────────────────────┴──────────────────┴──────────────┘ │    │   │ 10.42.1.0/24       │ 10.200.0.2       │ wg0 (eni)    │ │┃  ║
║   ┃   │                                                            │    │   │ 10.200.0.0/24      │ local            │ wg0 (eni)    │ │┃  ║
║   ┃   │   Gateway: 172.10.0.1 (Provider Network)                   │    │   └────────────────────┴──────────────────┴──────────────┘ │┃  ║
║   ┃   │   NAT: Floating IP mapping                                 │    │                                                            │┃  ║
║   ┃   │   SNAT: Internal → External                                │    │   Internet Gateway: igw-xxxxxxxx                          │┃  ║
║   ┃   └────────────────────────────────────────────────────────────┘    │   NAT Gateway: nat-xxxxxxxx (for private subnet)          │┃  ║
║   ┃                                                                      └────────────────────────────────────────────────────────────┘┃  ║
║   ┃                                                                                                                                    ┃  ║
║   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  ║
║                                                              │                                                                           ║
║   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  ║
║   ┃                                              LAYER 2 - DATA LINK LAYER                                                            ┃  ║
║   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫  ║
║   ┃                                                                                                                                    ┃  ║
║   ┃   ┌────────────────────────────────────────────────────────────┐    ┌────────────────────────────────────────────────────────────┐┃  ║
║   ┃   │              OPENSTACK OVS (Open vSwitch)                  │    │                  AWS VPC ENI (Elastic NI)                  │┃  ║
║   ┃   │                                                            │    │                                                            │┃  ║
║   ┃   │   br-int (Integration Bridge)                              │    │   ┌──────────────────────────────────────────────────────┐ │┃  ║
║   ┃   │   ├── tap-xxxxx (VM: master - 10.0.1.185)                  │    │   │              SECURITY GROUPS                         │ │┃  ║
║   ┃   │   ├── tap-yyyyy (VM: worker - 10.0.1.65)                   │    │   ├──────────────────────────────────────────────────────┤ │┃  ║
║   ┃   │   └── qr-zzzzz (Router internal port)                      │    │   │                                                      │ │┃  ║
║   ┃   │                                                            │    │   │ zta-wireguard-sg:                                    │ │┃  ║
║   ┃   │   br-ex (External Bridge)                                  │    │   │  • Inbound: UDP 51820 (WireGuard)                    │ │┃  ║
║   ┃   │   ├── qg-aaaaa (Router external port - 172.10.0.190)       │    │   │  • Inbound: TCP 22 (SSH)                             │ │┃  ║
║   ┃   │   └── Physical NIC (ens3/eth0)                             │    │   │  • Inbound: All from 172.10.0.0/24                   │ │┃  ║
║   ┃   │                                                            │    │   │  • Outbound: All                                     │ │┃  ║
║   ┃   │   VLAN Configuration:                                      │    │   │                                                      │ │┃  ║
║   ┃   │   ├── Provider VLAN: untagged (flat)                       │    │   │ zta-workload-sg:                                     │ │┃  ║
║   ┃   │   └── Tenant VLAN: Internal ID mapping                     │    │   │  • Inbound: All from wireguard-sg only              │ │┃  ║
║   ┃   │                                                            │    │   │  • Inbound: All from VPC CIDR                       │ │┃  ║
║   ┃   │   MAC Learning: Enabled                                    │    │   │  • Outbound: All                                     │ │┃  ║
║   ┃   │   ARP Proxy: Neutron L3 Agent                              │    │   │                                                      │ │┃  ║
║   ┃   └────────────────────────────────────────────────────────────┘    │   └──────────────────────────────────────────────────────┘ │┃  ║
║   ┃                                                                      │                                                            │┃  ║
║   ┃                                                                      │   ENI Attachments:                                        │┃  ║
║   ┃                                                                      │   ├── eni-wg (WireGuard GW - Public Subnet)               │┃  ║
║   ┃                                                                      │   │   ├── Private IP: 10.100.1.x                          │┃  ║
║   ┃                                                                      │   │   ├── Public IP: 18.143.117.69 (EIP)                  │┃  ║
║   ┃                                                                      │   │   └── source_dest_check: disabled                     │┃  ║
║   ┃                                                                      │   │                                                        │┃  ║
║   ┃                                                                      │   └── eni-worker (K3s Worker - Private Subnet)            │┃  ║
║   ┃                                                                      │       └── Private IP: 10.100.2.50                         │┃  ║
║   ┃                                                                      └────────────────────────────────────────────────────────────┘┃  ║
║   ┃                                                                                                                                    ┃  ║
║   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  ║
║                                                              │                                                                           ║
║   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  ║
║   ┃                                            LAYER 1 - PHYSICAL/INFRASTRUCTURE                                                      ┃  ║
║   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫  ║
║   ┃                                                                                                                                    ┃  ║
║   ┃   ┌────────────────────────────────────────────────────────────┐    ┌────────────────────────────────────────────────────────────┐┃  ║
║   ┃   │          OPENSTACK PHYSICAL INFRASTRUCTURE                 │    │             AWS PHYSICAL INFRASTRUCTURE                    │┃  ║
║   ┃   │                                                            │    │                                                            │┃  ║
║   ┃   │   ┌──────────────────────────────────────────────────────┐ │    │   ┌──────────────────────────────────────────────────────┐ │┃  ║
║   ┃   │   │           COMPUTE NODE (Physical Server)             │ │    │   │              EC2 INSTANCES                           │ │┃  ║
║   ┃   │   ├──────────────────────────────────────────────────────┤ │    │   ├──────────────────────────────────────────────────────┤ │┃  ║
║   ┃   │   │                                                      │ │    │   │                                                      │ │┃  ║
║   ┃   │   │  ┌────────────────┐    ┌────────────────┐            │ │    │   │  ┌────────────────┐    ┌────────────────┐            │ │┃  ║
║   ┃   │   │  │   VM: master   │    │   VM: worker   │            │ │    │   │  │ WireGuard GW   │    │  K3s Worker    │            │ │┃  ║
║   ┃   │   │  │   (KVM/QEMU)   │    │   (KVM/QEMU)   │            │ │    │   │  │   t3.micro     │    │   t3.medium    │            │ │┃  ║
║   ┃   │   │  │               │    │               │            │ │    │   │  │                │    │                │            │ │┃  ║
║   ┃   │   │  │ vCPU: 4       │    │ vCPU: 4       │            │ │    │   │  │ vCPU: 2        │    │ vCPU: 2        │            │ │┃  ║
║   ┃   │   │  │ RAM: 8GB      │    │ RAM: 8GB      │            │ │    │   │  │ RAM: 1GB       │    │ RAM: 4GB       │            │ │┃  ║
║   ┃   │   │  │ Disk: 40GB    │    │ Disk: 40GB    │            │ │    │   │  │ EBS: 20GB gp3  │    │ EBS: 30GB gp3  │            │ │┃  ║
║   ┃   │   │  │               │    │               │            │ │    │   │  │ Encrypted      │    │ Encrypted      │            │ │┃  ║
║   ┃   │   │  │ NIC: virtio   │    │ NIC: virtio   │            │ │    │   │  │                │    │                │            │ │┃  ║
║   ┃   │   │  │ eth0: tap-xxx │    │ eth0: tap-yyy │            │ │    │   │  │ AZ: ap-se-1a   │    │ AZ: ap-se-1a   │            │ │┃  ║
║   ┃   │   │  └────────────────┘    └────────────────┘            │ │    │   │  └────────────────┘    └────────────────┘            │ │┃  ║
║   ┃   │   │                                                      │ │    │   │                                                      │ │┃  ║
║   ┃   │   │  Hypervisor: KVM with libvirt                        │ │    │   │  Hypervisor: AWS Nitro System                        │ │┃  ║
║   ┃   │   │  Physical NIC: 1Gbps Ethernet                        │ │    │   │  Network: 25 Gbps (within AZ)                        │ │┃  ║
║   ┃   │   └──────────────────────────────────────────────────────┘ │    │   └──────────────────────────────────────────────────────┘ │┃  ║
║   ┃   │                                                            │    │                                                            │┃  ║
║   ┃   │   Physical Network:                                        │    │   AWS Global Infrastructure:                               │┃  ║
║   ┃   │   ├── ToR Switch (L2)                                      │    │   ├── Region: ap-southeast-1 (Singapore)                   │┃  ║
║   ┃   │   ├── Core Router (L3)                                     │    │   ├── Availability Zone: ap-southeast-1a                   │┃  ║
║   ┃   │   └── ISP Gateway → Internet                               │    │   └── AWS Backbone → Internet                              │┃  ║
║   ┃   └────────────────────────────────────────────────────────────┘    └────────────────────────────────────────────────────────────┘┃  ║
║   ┃                                                                                                                                    ┃  ║
║   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  ║
║                                                                                                                                          ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╝
```

### Bảng tổng hợp IP Addresses và Network Segments

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    IP ADDRESS ALLOCATION TABLE                                                   │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                 │
│   ┌──────────────────────────────────────────────┬──────────────────────────────────────────────────────────┐   │
│   │              OPENSTACK NETWORKS              │                    AWS NETWORKS                          │   │
│   ├──────────────────────────────────────────────┼──────────────────────────────────────────────────────────┤   │
│   │                                              │                                                          │   │
│   │  UNDERLAY NETWORKS:                          │  UNDERLAY NETWORKS:                                      │   │
│   │  ┌────────────────────────────────────────┐  │  ┌────────────────────────────────────────────────────┐  │   │
│   │  │ Provider Network: 172.10.0.0/24        │  │  │ VPC CIDR: 10.100.0.0/16                            │  │   │
│   │  │  • Gateway: 172.10.0.1                 │  │  │  • Public Subnet: 10.100.1.0/24                    │  │   │
│   │  │  • Floating IP Pool: 172.10.0.100-250  │  │  │  • Private Subnet: 10.100.2.0/24                   │  │   │
│   │  │  • K3s Master FIP: 172.10.0.190        │  │  │                                                    │  │   │
│   │  ├────────────────────────────────────────┤  │  │ Internet Gateway: igw-xxxxxxxxx                    │  │   │
│   │  │ Tenant Network: 10.0.1.0/24            │  │  │ NAT Gateway: nat-xxxxxxxxx                         │  │   │
│   │  │  • K3s Master: 10.0.1.185              │  │  │  • Elastic IP: x.x.x.x                             │  │   │
│   │  │  • K3s Worker: 10.0.1.65               │  │  └────────────────────────────────────────────────────┘  │   │
│   │  │  • DHCP Range: 10.0.1.2-254            │  │                                                          │   │
│   │  └────────────────────────────────────────┘  │  INSTANCE IPs:                                           │   │
│   │                                              │  ┌────────────────────────────────────────────────────┐  │   │
│   │  OVERLAY NETWORKS:                           │  │ WireGuard Gateway (Public Subnet):                 │  │   │
│   │  ┌────────────────────────────────────────┐  │  │  • Private IP: 10.100.1.x                          │  │   │
│   │  │ WireGuard Tunnel: 10.200.0.0/24        │  │  │  • Public IP (EIP): 18.143.117.69                  │  │   │
│   │  │  • OpenStack Endpoint: 10.200.0.2      │  │  │  • Tunnel IP: 10.200.0.1                           │  │   │
│   │  │  • AWS Endpoint: 10.200.0.1            │  │  ├────────────────────────────────────────────────────┤  │   │
│   │  ├────────────────────────────────────────┤  │  │ K3s Worker (Private Subnet):                       │  │   │
│   │  │ K8s Pod Network: 10.42.0.0/16          │  │  │  • Private IP: 10.100.2.50                         │  │   │
│   │  │  • Master Pods: 10.42.0.0/24           │  │  │  • Node IP for K3s: 10.200.0.1 (via WG)            │  │   │
│   │  │  • Worker Pods: 10.42.1.0/24           │  │  │  • Pod CIDR: 10.42.3.0/24                          │  │   │
│   │  │  • AWS Worker Pods: 10.42.3.0/24       │  │  └────────────────────────────────────────────────────┘  │   │
│   │  ├────────────────────────────────────────┤  │                                                          │   │
│   │  │ K8s Service Network: 10.43.0.0/16      │  │  OVERLAY NETWORKS (Shared):                             │   │
│   │  │  • ClusterIP Range: 10.43.0.0/16       │  │  ┌────────────────────────────────────────────────────┐  │   │
│   │  │  • CoreDNS: 10.43.0.10                 │  │  │ Same Kubernetes overlay networks                   │  │   │
│   │  │  • API Server: 10.43.0.1               │  │  │  • Pod Network: 10.42.0.0/16                       │  │   │
│   │  └────────────────────────────────────────┘  │  │  • Service Network: 10.43.0.0/16                   │  │   │
│   │                                              │  │  • VXLAN VNI: 1 (Flannel default)                  │  │   │
│   │                                              │  └────────────────────────────────────────────────────┘  │   │
│   └──────────────────────────────────────────────┴──────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### Packet Flow: OpenStack Pod → AWS Pod (Cross-Cloud Communication)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              PACKET FLOW: demo-app (OpenStack) → tkb-service (AWS)                              │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                 │
│   ① APPLICATION LAYER                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  demo-app Pod (10.42.0.50) sends HTTP request to tkb-service                                            │   │
│   │  curl http://10.200.0.1:30080/api/tkb                                                                   │   │
│   │                                                                                                         │   │
│   │  HTTP Headers:                                                                                          │   │
│   │  ├── Host: 10.200.0.1:30080                                                                             │   │
│   │  ├── x-forwarded-user: gv1                                                                              │   │
│   │  └── x-forwarded-groups: giangvien                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              ↓                                                                  │
│   ② ISTIO SIDECAR (mTLS Encryption)                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  Envoy Proxy intercepts outbound traffic                                                                │   │
│   │  ├── Source SPIFFE ID: spiffe://cluster.local/ns/demo/sa/demo-app                                       │   │
│   │  ├── mTLS handshake with destination (if within mesh)                                                   │   │
│   │  └── Traffic exits mesh at node level for external destination                                          │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              ↓                                                                  │
│   ③ KUBERNETES CNI (Flannel)                                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  Destination: 10.200.0.1 (not in Pod CIDR)                                                              │   │
│   │  Route lookup → Default gateway → Node's eth0/ens3                                                      │   │
│   │  Packet leaves Pod network, enters Node's host network                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              ↓                                                                  │
│   ④ LINUX ROUTING (Master Node: 10.0.1.185)                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  ip route shows:                                                                                        │   │
│   │  10.200.0.0/24 dev wg0 scope link                                                                       │   │
│   │                                                                                                         │   │
│   │  Packet routed to wg0 interface                                                                         │   │
│   │  Source IP: 10.0.1.185 (or NAT to 10.200.0.2)                                                           │   │
│   │  Dest IP: 10.200.0.1                                                                                    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              ↓                                                                  │
│   ⑤ WIREGUARD ENCRYPTION (wg0 Interface)                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  WireGuard encrypts packet:                                                                             │   │
│   │  ├── Encryption: ChaCha20-Poly1305                                                                      │   │
│   │  ├── Authentication: Curve25519 key exchange                                                            │   │
│   │  ├── Peer lookup: 10.200.0.1 → AWS Public Key                                                           │   │
│   │  └── Encapsulate in UDP packet                                                                          │   │
│   │                                                                                                         │   │
│   │  New packet:                                                                                            │   │
│   │  ├── Outer Src IP: 172.10.0.190 (Floating IP)                                                           │   │
│   │  ├── Outer Dst IP: 18.143.117.69 (AWS EIP)                                                              │   │
│   │  ├── Outer Protocol: UDP                                                                                │   │
│   │  ├── Outer Dst Port: 51820                                                                              │   │
│   │  └── Payload: [Encrypted original packet]                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              ↓                                                                  │
│   ⑥ OPENSTACK NEUTRON (NAT/Floating IP)                                                                        │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  SNAT: Internal IP → Floating IP                                                                        │   │
│   │  10.0.1.185 → 172.10.0.190                                                                              │   │
│   │  Packet exits through br-ex → Physical NIC → Internet                                                   │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              ↓                                                                  │
│   ⑦ INTERNET TRANSIT                                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  UDP packet traverses Internet                                                                          │   │
│   │  172.10.0.190:random → 18.143.117.69:51820                                                              │   │
│   │  Latency: ~20-50ms (Vietnam → Singapore)                                                                │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              ↓                                                                  │
│   ⑧ AWS VPC (Security Group Check)                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  zta-wireguard-sg allows:                                                                               │   │
│   │  ├── UDP 51820 from 0.0.0.0/0 ✓                                                                         │   │
│   │  └── Packet accepted                                                                                    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              ↓                                                                  │
│   ⑨ WIREGUARD DECRYPTION (AWS wg0)                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  WireGuard decrypts packet:                                                                             │   │
│   │  ├── Verify peer public key (OpenStack)                                                                 │   │
│   │  ├── Decrypt with shared secret                                                                         │   │
│   │  └── Original packet restored                                                                           │   │
│   │                                                                                                         │   │
│   │  Decrypted packet:                                                                                      │   │
│   │  ├── Src IP: 10.200.0.2 (or original 10.0.1.185)                                                        │   │
│   │  ├── Dst IP: 10.200.0.1                                                                                 │   │
│   │  ├── Protocol: TCP                                                                                      │   │
│   │  └── Dst Port: 30080                                                                                    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              ↓                                                                  │
│   ⑩ LINUX ROUTING (AWS WireGuard GW → K3s Worker)                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  iptables MASQUERADE or direct routing                                                                  │   │
│   │  Forward to K3s Worker Node: 10.100.2.50                                                                │   │
│   │  Or local if WireGuard GW is also K3s node                                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              ↓                                                                  │
│   ⑪ KUBERNETES NodePort SERVICE                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  kube-proxy iptables rules:                                                                             │   │
│   │  NodePort 30080 → tkb-service ClusterIP → Pod IP                                                        │   │
│   │  DNAT: 10.200.0.1:30080 → 10.42.3.x:3000                                                                │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              ↓                                                                  │
│   ⑫ TKB-SERVICE POD                                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │  Node.js Express app receives request                                                                   │   │
│   │  ├── Reads x-forwarded-groups header                                                                    │   │
│   │  ├── Returns TKB data based on role                                                                     │   │
│   │  └── Response travels back through same path (reversed)                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│   RESPONSE PATH: ⑫ → ⑪ → ⑩ → ⑨ → ⑧ → ⑦ → ⑥ → ⑤ → ④ → ③ → ② → ①                                              │
│                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### Tóm tắt các tầng mạng

| Tầng | OpenStack | AWS | Giao thức/Công nghệ |
|------|-----------|-----|---------------------|
| **L1 - Physical** | KVM/QEMU VMs trên Physical Server | EC2 Instances (Nitro) | Ethernet, Fiber |
| **L2 - Data Link** | OVS (br-int, br-ex), VLAN tagging | VPC ENI, Security Groups | MAC, ARP, VLAN |
| **L3 - Network** | Neutron Router, NAT, Floating IP | VPC Router, IGW, NAT GW | IP, ICMP |
| **Overlay - VPN** | WireGuard wg0 (10.200.0.2) | WireGuard wg0 (10.200.0.1) | ChaCha20, UDP 51820 |
| **Overlay - K8s** | Flannel VXLAN (10.42.x.0/24) | Flannel VXLAN (10.42.3.0/24) | VXLAN VNI 1, UDP 8472 |
| **Overlay - Mesh** | Istio Envoy Sidecar | Istio Envoy Sidecar | mTLS, SPIFFE |
| **L7 - Application** | Keycloak, OAuth2-Proxy, Demo-App | TKB-Service | HTTP, gRPC, JWT |

---

## 🏢 KIẾN TRÚC ENTERPRISE: AWS DIRECT CONNECT + TRANSIT GATEWAY

### Tại sao cần Direct Connect thay vì VPN?

| Tiêu chí | WireGuard VPN | AWS Site-to-Site VPN | AWS Direct Connect |
|----------|---------------|----------------------|-------------------|
| **Bandwidth** | ~100Mbps | 1.25Gbps | 1-100Gbps |
| **Latency** | Variable (50-100ms) | Variable (20-50ms) | Consistent (<5ms) |
| **Reliability** | Single point of failure | AWS managed, HA | Dedicated, SLA 99.99% |
| **Security** | ChaCha20 encryption | IPSec | Private connection + MACsec |
| **Scalability** | Limited | Up to 10 tunnels | Unlimited VIFs |
| **Cost** | Free | ~$0.05/hr | $0.30/port-hour + data |
| **Use Case** | Lab/Dev | Small production | Enterprise production |

### Kiến trúc đề xuất cho Production

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                         ENTERPRISE HYBRID CLOUD ARCHITECTURE                                                     │
│                         AWS Direct Connect + Transit Gateway                                                     │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                 │
│   ┌───────────────────────────────────────┐                 ┌───────────────────────────────────────────────┐   │
│   │       ON-PREMISES DATA CENTER         │                 │              AWS CLOUD                        │   │
│   │           (OpenStack)                 │                 │         (ap-southeast-1)                      │   │
│   └───────────────────────────────────────┘                 └───────────────────────────────────────────────┘   │
│                    │                                                           │                                │
│                    │                                                           │                                │
│   ┌────────────────┴───────────────────────────────────────────────────────────┴────────────────────────────┐   │
│   │                                                                                                          │   │
│   │   ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────────┐    │   │
│   │   │  K3s Cluster    │      │  Customer       │      │  AWS Direct     │      │  AWS Transit        │    │   │
│   │   │  (OpenStack)    │      │  Router         │      │  Connect        │      │  Gateway            │    │   │
│   │   │                 │      │  (BGP Enabled)  │      │  Location       │      │                     │    │   │
│   │   │  master         │      │                 │      │  (Equinix SG1)  │      │  Attachments:       │    │   │
│   │   │  worker         │──────│  ASN: 65000     │══════│                 │══════│  - VPC-Workload     │    │   │
│   │   │                 │      │                 │      │  1Gbps/10Gbps   │      │  - VPC-Management   │    │   │
│   │   │  10.0.1.0/24    │      │  BGP Peering    │      │  Dedicated      │      │  - Direct Connect   │    │   │
│   │   │                 │      │                 │      │  Connection     │      │  - VPN (Backup)     │    │   │
│   │   └─────────────────┘      └─────────────────┘      └─────────────────┘      └──────────┬──────────┘    │   │
│   │                                                                                         │               │   │
│   │                                                                                         │               │   │
│   │                                              ┌──────────────────────────────────────────┴───────────┐   │   │
│   │                                              │                                                      │   │   │
│   │                                              ▼                                                      ▼   │   │
│   │                                    ┌─────────────────────┐                           ┌─────────────────┐│   │
│   │                                    │   VPC: Workload     │                           │ VPC: Management ││   │
│   │                                    │   10.100.0.0/16     │                           │ 10.200.0.0/16   ││   │
│   │                                    │                     │                           │                 ││   │
│   │                                    │  ┌───────────────┐  │                           │ ┌─────────────┐ ││   │
│   │                                    │  │ Private Subnet│  │                           │ │ Monitoring  │ ││   │
│   │                                    │  │ 10.100.2.0/24 │  │                           │ │ & Logging   │ ││   │
│   │                                    │  │               │  │                           │ │             │ ││   │
│   │                                    │  │ K3s Workers:  │  │                           │ │ CloudWatch  │ ││   │
│   │                                    │  │ - aws-worker-1│  │                           │ │ VPC Flow    │ ││   │
│   │                                    │  │ - aws-worker-2│  │                           │ │ Logs        │ ││   │
│   │                                    │  │ - aws-worker-N│  │                           │ └─────────────┘ ││   │
│   │                                    │  │               │  │                           │                 ││   │
│   │                                    │  │ TKB Service   │  │                           │                 ││   │
│   │                                    │  │ Other µSvc    │  │                           │                 ││   │
│   │                                    │  └───────────────┘  │                           └─────────────────┘│   │
│   │                                    │                     │                                              │   │
│   │                                    └─────────────────────┘                                              │   │
│   │                                                                                                          │   │
│   └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│   ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                     ROUTING & CONNECTIVITY                                               │   │
│   ├──────────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                                                          │   │
│   │   On-Premises → AWS:                                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  10.0.1.0/24 (OpenStack) ──BGP──► Customer Router ──DX──► Transit Gateway ──► 10.100.0.0/16   │   │   │
│   │   │                                                                                                 │   │   │
│   │   │  Route Advertisement:                                                                           │   │   │
│   │   │  - On-prem advertises: 10.0.1.0/24, 10.42.0.0/24, 10.42.1.0/24                                 │   │   │
│   │   │  - AWS advertises: 10.100.0.0/16, 10.42.3.0/24                                                 │   │   │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                                                          │   │
│   │   Failover Path (Site-to-Site VPN as backup):                                                            │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  10.0.1.0/24 ──IPSec VPN──► VPN Gateway ──► Transit Gateway ──► 10.100.0.0/16                  │   │   │
│   │   │  (Lower BGP priority, activates if DX fails)                                                    │   │   │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                                                          │   │
│   └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### Chi tiết AWS Direct Connect Components

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                               AWS DIRECT CONNECT - DETAILED VIEW                                                 │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    PHYSICAL LAYER                                                        │   │
│   │                                                                                                         │   │
│   │   On-Premises                    Colocation/DX Location              AWS Region                         │   │
│   │   Data Center                    (Equinix SG1)                      (ap-southeast-1)                    │   │
│   │                                                                                                         │   │
│   │   ┌─────────────┐    Fiber      ┌─────────────────────┐    Fiber    ┌─────────────────┐                 │   │
│   │   │ Customer    │ ═══════════► │ Cross Connect       │ ═══════════► │ AWS Direct      │                 │   │
│   │   │ Router      │   Leased     │ (Meet-Me Room)      │   Dedicated │ Connect Router  │                 │   │
│   │   │             │   Line       │                     │   Port      │                 │                 │   │
│   │   │ ASN: 65000  │   1Gbps      │ Patch Panel         │   1/10Gbps  │ ASN: 7224       │                 │   │
│   │   └─────────────┘              └─────────────────────┘              └─────────────────┘                 │   │
│   │                                                                                                         │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    LOGICAL LAYER                                                         │   │
│   │                                                                                                         │   │
│   │   ┌───────────────────────────────────────────────────────────────────────────────────────────────────┐ │   │
│   │   │                          Direct Connect Gateway (DXGW)                                            │ │   │
│   │   │                                                                                                   │ │   │
│   │   │   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │ │   │
│   │   │   │                                                                                             │ │ │   │
│   │   │   │   Virtual Interfaces (VIFs):                                                                │ │ │   │
│   │   │   │                                                                                             │ │ │   │
│   │   │   │   ┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐              │ │ │   │
│   │   │   │   │ Private VIF         │   │ Private VIF         │   │ Transit VIF         │              │ │ │   │
│   │   │   │   │ (for VPC)           │   │ (for VPC)           │   │ (for TGW)           │              │ │ │   │
│   │   │   │   │                     │   │                     │   │                     │              │ │ │   │
│   │   │   │   │ VLAN: 100           │   │ VLAN: 200           │   │ VLAN: 300           │              │ │ │   │
│   │   │   │   │ BGP ASN: 65000      │   │ BGP ASN: 65000      │   │ BGP ASN: 65000      │              │ │ │   │
│   │   │   │   │ BGP Peer: x.x.x.x   │   │ BGP Peer: x.x.x.x   │   │ BGP Peer: x.x.x.x   │              │ │ │   │
│   │   │   │   │                     │   │                     │   │                     │              │ │ │   │
│   │   │   │   │ → VPC Workload      │   │ → VPC Management    │   │ → Transit Gateway   │              │ │ │   │
│   │   │   │   │   10.100.0.0/16     │   │   10.200.0.0/16     │   │   (Multiple VPCs)   │              │ │ │   │
│   │   │   │   └─────────────────────┘   └─────────────────────┘   └─────────────────────┘              │ │ │   │
│   │   │   │                                                                                             │ │ │   │
│   │   │   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │ │   │
│   │   │                                                                                                   │ │   │
│   │   └───────────────────────────────────────────────────────────────────────────────────────────────────┘ │   │
│   │                                                                                                         │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    SECURITY LAYER                                                        │   │
│   │                                                                                                         │   │
│   │   ┌───────────────────┐    ┌───────────────────┐    ┌───────────────────┐    ┌───────────────────┐     │   │
│   │   │ MACsec            │    │ BGP MD5           │    │ Private           │    │ AWS Security      │     │   │
│   │   │ Encryption        │    │ Authentication    │    │ Connection        │    │ Groups            │     │   │
│   │   │ (Layer 2)         │    │ (Routing)         │    │ (No Internet)     │    │ (Layer 4)         │     │   │
│   │   │                   │    │                   │    │                   │    │                   │     │   │
│   │   │ AES-256-GCM       │    │ Prevents route    │    │ Traffic never     │    │ Ingress/Egress    │     │   │
│   │   │ Line-rate         │    │ injection         │    │ touches public    │    │ rules per VPC     │     │   │
│   │   │ encryption        │    │                   │    │ internet          │    │                   │     │   │
│   │   └───────────────────┘    └───────────────────┘    └───────────────────┘    └───────────────────┘     │   │
│   │                                                                                                         │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 SO SÁNH: LAB vs PRODUCTION ARCHITECTURE

### Kiến trúc Lab (Hiện tại - WireGuard VPN)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                        LAB ENVIRONMENT                                      │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│   OpenStack                          AWS                                   │
│   ┌──────────────┐                   ┌──────────────┐                     │
│   │ K3s Cluster  │                   │ K3s Worker   │                     │
│   │              │   WireGuard VPN   │              │                     │
│   │ master       │ ════════════════► │ aws-worker-1 │                     │
│   │ worker       │   10.200.0.2      │ 10.200.0.1   │                     │
│   │              │   UDP 51820       │              │                     │
│   │              │   ChaCha20        │ TKB Service  │                     │
│   └──────────────┘                   └──────────────┘                     │
│                                                                            │
│   Pros:                              Cons:                                 │
│   ✅ Simple setup                    ❌ Single point of failure           │
│   ✅ Free                            ❌ Limited bandwidth                  │
│   ✅ Works for demo                  ❌ Variable latency                   │
│                                      ❌ Not scalable                       │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

### Kiến trúc Production (Đề xuất - Direct Connect)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                     PRODUCTION ENVIRONMENT                                  │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│   On-Premises DC                     AWS                                   │
│   ┌──────────────┐                   ┌──────────────────────────────┐     │
│   │ K3s Cluster  │   Direct Connect  │        Transit Gateway       │     │
│   │              │ ══════════════════│                              │     │
│   │ master       │   1-10 Gbps       │  ┌──────────┐ ┌──────────┐  │     │
│   │ worker-1     │   <5ms latency    │  │VPC-Prod  │ │VPC-Dev   │  │     │
│   │ worker-2     │   99.99% SLA      │  │          │ │          │  │     │
│   │ worker-N     │                   │  │workers   │ │workers   │  │     │
│   │              │   + VPN Backup    │  │10-100    │ │1-10      │  │     │
│   │              │ ─ ─ ─ ─ ─ ─ ─ ─ ─►│  └──────────┘ └──────────┘  │     │
│   └──────────────┘                   └──────────────────────────────┘     │
│                                                                            │
│   Pros:                              Requirements:                         │
│   ✅ High availability               📋 Colocation presence               │
│   ✅ Consistent performance          📋 BGP-capable router                │
│   ✅ Scales to many workers          📋 Monthly cost ~$500+               │
│   ✅ Enterprise SLA                  📋 AWS Enterprise Support            │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```
│   ║   │                        VPC: 10.100.0.0/16                                   │    ║  │
│   ║   │                                                                             │    ║  │
│   ║   │  ┌─────────────────────────┐    ┌─────────────────────────────────────┐    │    ║  │
│   ║   │  │   PUBLIC SUBNET         │    │       PRIVATE SUBNET                │    │    ║  │
│   ║   │  │   10.100.1.0/24         │    │       10.100.2.0/24                 │    │    ║  │
│   ║   │  │                         │    │                                     │    │    ║  │
│   ║   │  │  ┌───────────────────┐  │    │  ┌───────────────────────────────┐  │    │    ║  │
│   ║   │  │  │  WIREGUARD GW     │  │    │  │      K3s WORKER NODE          │  │    │    ║  │
│   ║   │  │  │  t3.micro         │  │    │  │      (aws-worker-1)           │  │    │    ║  │
│   ║   │  │  │                   │  │    │  │                               │  │    │    ║  │
│   ║   │  │  │  Public IP:       │  │    │  │  ┌─────────────────────────┐  │  │    │    ║  │
│   ║   │  │  │  18.143.117.69    │  │    │  │  │    TKB-SERVICE          │  │  │    │    ║  │
│   ║   │  │  │                   │  │    │  │  │    (Node.js/Express)    │  │  │    │    ║  │
│   ║   │  │  │  WG Tunnel IP:    │  │    │  │  │                         │  │  │    │    ║  │
│   ║   │  │  │  10.200.0.1       │◄─┼────┼──┼─►│  NodePort: 30080        │  │  │    │    ║  │
│   ║   │  │  │                   │  │    │  │  │                         │  │  │    │    ║  │
│   ║   │  │  │  :51820 UDP       │  │    │  │  │  GET /api/tkb           │  │  │    │    ║  │
│   ║   │  │  └───────────────────┘  │    │  │  │  - giangvien → TKB GV   │  │  │    │    ║  │
│   ║   │  │                         │    │  │  │  - sinhvien → TKB SV    │  │  │    │    ║  │
│   ║   │  └─────────────────────────┘    │  │  └─────────────────────────┘  │  │    │    ║  │
│   ║   │                                  │  │                               │  │    │    ║  │
│   ║   │                                  │  │  Joined to K3s cluster via   │  │    │    ║  │
│   ║   │                                  │  │  WireGuard (node-ip:10.200.0.1)│ │    │    ║  │
│   ║   │                                  │  └───────────────────────────────┘  │    │    ║  │
│   ║   │                                  └─────────────────────────────────────┘    │    ║  │
│   ║   │                                                                             │    ║  │
│   ║   │  Security Groups:                                                           │    ║  │
│   ║   │  • wireguard-sg: UDP 51820, SSH 22, All from 172.10.0.0/24                 │    ║  │
│   ║   │  • workload-sg: Only from wireguard-sg (Zero Trust)                        │    ║  │
│   ║   │                                                                             │    ║  │
│   ║   │  VPC Flow Logs → CloudWatch (Security Monitoring)                          │    ║  │
│   ║   └─────────────────────────────────────────────────────────────────────────────┘    ║  │
│   ║                                                                                       ║  │
│   ╚═══════════════════════════════════════════════════════════════════════════════════════╝  │
│                                                                                               │
└───────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔐 Zero Trust Principles Implementation

### 1. Never Trust, Always Verify (Không bao giờ tin, luôn xác thực)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    AUTHENTICATION FLOW                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   User Request (no token)                                               │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────┐                                                       │
│   │ Istio GW    │                                                       │
│   └──────┬──────┘                                                       │
│          │                                                              │
│          ▼                                                              │
│   ┌─────────────┐     No valid session     ┌─────────────┐              │
│   │OAuth2-Proxy │ ─────────────────────────►│  Keycloak   │             │
│   │             │◄─────────────────────────│  Login Page │              │
│   └──────┬──────┘     Redirect             └──────┬──────┘              │
│          │                                        │                     │
│          │                                        ▼                     │
│          │                              ┌─────────────────┐             │
│          │                              │ User enters     │             │
│          │                              │ username/password│            │
│          │                              └────────┬────────┘             │
│          │                                       │                      │
│          │         JWT Token + ID Token          │                      │
│          │◄──────────────────────────────────────┘                      │
│          │                                                              │
│          ▼                                                              │
│   ┌─────────────┐                                                       │
│   │ Set Headers │                                                       │
│   │ x-forwarded │                                                       │
│   │ -user       │                                                       │
│   │ -groups     │                                                       │
│   │ -email      │                                                       │
│   └──────┬──────┘                                                       │
│          │                                                              │
│          ▼                                                              │
│   ┌─────────────┐                                                       │
│   │  Demo-App   │  ← Receives authenticated request with user info      │
│   └─────────────┘                                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2. Least Privilege Access (Quyền truy cập tối thiểu)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ROLE-BASED ACCESS CONTROL (RBAC)                     │
│                    + OPA POLICY DECISION POINT                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Keycloak Realm: zta                                                   │
│   ├── Groups                                                            │
│   │   ├── giangvien                                                     │
│   │   │   └── Users: gv1                                               │
│   │   └── sinhvien                                                      │
│   │       └── Users: sv1                                               │
│   │                                                                     │
│   OPA Rego Policy (authz.rego):                                        │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │ role_permissions := {                                            │  │
│   │   "giangvien": ["/api/giangvien", "/api/sinhvien",              │  │
│   │                 "/api/tkb", "/api/me"],                          │  │
│   │   "sinhvien":  ["/api/sinhvien", "/api/tkb", "/api/me"]         │  │
│   │ }                                                                │  │
│   │                                                                  │  │
│   │ default allow := false  # Zero Trust - Deny by default          │  │
│   │                                                                  │  │
│   │ allow if {                                                       │  │
│   │   some role, paths in role_permissions                          │  │
│   │   input.role == role                                            │  │
│   │   some path in paths                                            │  │
│   │   input.path == path                                            │  │
│   │ }                                                                │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   API Access Matrix (enforced by OPA):                                 │
│   ┌──────────────────┬────────────┬────────────┬────────────┐          │
│   │ Endpoint         │ Anonymous  │ sinhvien   │ giangvien  │          │
│   ├──────────────────┼────────────┼────────────┼────────────┤          │
│   │ /                │ ❌ 302     │ ✅ 200     │ ✅ 200     │          │
│   │ /api/me          │ ❌ 302     │ ✅ 200     │ ✅ 200     │          │
│   │ /api/sinhvien    │ ❌ 302     │ ✅ 200     │ ✅ 200     │          │
│   │ /api/giangvien   │ ❌ 302     │ ❌ 403     │ ✅ 200     │          │
│   │ /api/tkb         │ ❌ 302     │ ✅ TKB_SV  │ ✅ TKB_GV  │          │
│   └──────────────────┴────────────┴────────────┴────────────┘          │
│   └──────────────────┴────────────┴────────────┴────────────┘          │
│                                                                         │
│   TKB Response differs by role:                                        │
│   • giangvien: Sees classes they teach, rooms, student groups          │
│   • sinhvien: Sees their schedule with teacher names                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3. Assume Breach (Giả định đã bị xâm nhập)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    DEFENSE IN DEPTH                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Layer 1: Network Perimeter                                            │
│   ├── Istio Ingress Gateway (single entry point)                       │
│   └── AWS Security Groups (deny by default)                            │
│                                                                         │
│   Layer 2: Authentication (AuthN)                                       │
│   ├── OAuth2-Proxy (session validation)                                │
│   └── Keycloak (OIDC/JWT verification)                                 │
│                                                                         │
│   Layer 3: Authorization (AuthZ) - OPA Policy Engine                   │
│   ├── Open Policy Agent (Rego policies)                                │
│   ├── Policy-as-Code: versioned, auditable                             │
│   ├── Fine-grained RBAC                                                │
│   └── Default DENY - Zero Trust principle                              │
│                                                                         │
│   Layer 4: Workload Identity - SPIFFE/SPIRE                            │
│   ├── SPIRE Server (Trust Domain: zta.local)                           │
│   ├── Short-lived certificates (CA TTL: 24h)                           │
│   ├── Automatic certificate rotation                                   │
│   └── Cryptographic workload attestation                               │
│                                                                         │
│   Layer 5: Encryption                                                   │
│   ├── WireGuard VPN (cross-cloud traffic)                              │
│   ├── Istio mTLS (service-to-service) with SPIFFE IDs                  │
│   └── HTTPS (client-to-gateway)                                        │
│                                                                         │
│   Layer 6: Monitoring & Detection                                       │
│   ├── Prometheus (metrics collection)                                  │
│   ├── Grafana (visualization & alerting)                               │
│   ├── Loki (log aggregation)                                           │
│   └── AWS VPC Flow Logs (network traffic)                              │
│                                                                         │
│   Layer 7: Microsegmentation                                            │
│   ├── Kubernetes Network Policies                                      │
│   ├── Namespace isolation                                              │
│   └── Pod-level security contexts                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4. Verify Explicitly (Xác thực rõ ràng)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SECURITY HEADERS FLOW                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Attacker tries to inject headers:                                     │
│   curl -H "x-forwarded-user: admin" http://app.../api/giangvien        │
│                                                                         │
│   ┌─────────────┐                                                       │
│   │ Istio GW    │ ← Receives request with fake headers                 │
│   └──────┬──────┘                                                       │
│          │                                                              │
│          ▼                                                              │
│   ┌─────────────┐                                                       │
│   │OAuth2-Proxy │ ← STRIPS all incoming x-forwarded-* headers          │
│   │             │ ← Checks for valid session cookie                    │
│   │             │ ← No valid session? → Redirect to Keycloak           │
│   └─────────────┘                                                       │
│                                                                         │
│   ✅ Result: Headers are only set by OAuth2-Proxy after                │
│      successful authentication with Keycloak                           │
│                                                                         │
│   OAuth2-Proxy adds TRUSTED headers:                                   │
│   • x-forwarded-user: (from JWT 'preferred_username')                  │
│   • x-forwarded-email: (from JWT 'email')                              │
│   • x-forwarded-groups: (from JWT 'groups' claim)                      │
│   • Authorization: Bearer <access_token>                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🌐 Hybrid Cloud Communication

### WireGuard VPN Tunnel

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    WIREGUARD VPN CONFIGURATION                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   OPENSTACK SIDE (10.200.0.2)                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │ [Interface]                                                     │  │
│   │ PrivateKey = <openstack_private_key>                           │  │
│   │ Address = 10.200.0.2/24                                        │  │
│   │ ListenPort = 51820                                             │  │
│   │                                                                 │  │
│   │ [Peer]                                                          │  │
│   │ # AWS Gateway                                                   │  │
│   │ PublicKey = F1VpZHOBjxNo31bOWKzlPyTdK/DvyCfX+5vDG0m+tyo=       │  │
│   │ Endpoint = 18.143.117.69:51820                                 │  │
│   │ AllowedIPs = 10.100.0.0/16, 10.200.0.1/32, 10.42.3.0/24        │  │
│   │ PersistentKeepalive = 25                                       │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│                              ▲                                          │
│                              │ Encrypted UDP                            │
│                              │ ChaCha20-Poly1305                        │
│                              ▼                                          │
│                                                                         │
│   AWS SIDE (10.200.0.1)                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │ [Interface]                                                     │  │
│   │ PrivateKey = <aws_private_key>                                 │  │
│   │ Address = 10.200.0.1/24                                        │  │
│   │ ListenPort = 51820                                             │  │
│   │                                                                 │  │
│   │ [Peer]                                                          │  │
│   │ # OpenStack Gateway                                             │  │
│   │ PublicKey = IrCx8G8pOTRYq6hchmAyqnIArGJdkbUxWz5s9BaXBBA=       │  │
│   │ AllowedIPs = 172.10.0.0/24, 10.200.0.2/32, 10.0.1.0/24,        │  │
│   │              10.42.0.0/24, 10.42.1.0/24                        │  │
│   │ PersistentKeepalive = 25                                       │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Cross-Cloud Service Communication

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    /api/tkb REQUEST FLOW                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   1. User requests /api/tkb                                             │
│      │                                                                  │
│      ▼                                                                  │
│   2. Istio Gateway receives request                                     │
│      │                                                                  │
│      ▼                                                                  │
│   3. OAuth2-Proxy checks session                                        │
│      │ (adds x-forwarded-user, x-forwarded-groups headers)              │
│      ▼                                                                  │
│   4. Demo-App (OpenStack) receives authenticated request                │
│      │                                                                  │
│      │  ┌────────────────────────────────────────────────────────────┐ │
│      │  │ async def proxy_tkb(request: Request):                     │ │
│      │  │     headers = {                                            │ │
│      │  │         "x-forwarded-user": request.headers.get(...),      │ │
│      │  │         "x-forwarded-groups": request.headers.get(...),    │ │
│      │  │     }                                                      │ │
│      │  │     response = await client.get(                           │ │
│      │  │         "http://10.200.0.1:30080/api/tkb",  # AWS via VPN  │ │
│      │  │         headers=headers                                    │ │
│      │  │     )                                                      │ │
│      │  └────────────────────────────────────────────────────────────┘ │
│      │                                                                  │
│      ▼                                                                  │
│   5. Request goes through WireGuard VPN (10.200.0.2 → 10.200.0.1)      │
│      │                                                                  │
│      ▼                                                                  │
│   6. TKB-Service (AWS) receives request                                 │
│      │                                                                  │
│      │  ┌────────────────────────────────────────────────────────────┐ │
│      │  │ app.get('/api/tkb', (req, res) => {                        │ │
│      │  │     const groups = req.headers['x-forwarded-groups'];      │ │
│      │  │     if (groups.includes('giangvien')) {                    │ │
│      │  │         return res.json({ schedule: schedule.giangvien }); │ │
│      │  │     } else if (groups.includes('sinhvien')) {              │ │
│      │  │         return res.json({ schedule: schedule.sinhvien });  │ │
│      │  │     }                                                      │ │
│      │  │ });                                                        │ │
│      │  └────────────────────────────────────────────────────────────┘ │
│      │                                                                  │
│      ▼                                                                  │
│   7. Response returns through same path                                 │
│      │                                                                  │
│      ▼                                                                  │
│   8. User receives TKB data specific to their role                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 Deployed Services Summary

### OpenStack (On-Premises)

| Service | Namespace | Port | Description |
|---------|-----------|------|-------------|
| Istio Ingress Gateway | istio-system | 31691 | Entry point for all traffic |
| Keycloak | demo | 8080 | Identity Provider (OIDC) |
| OAuth2-Proxy | demo | 4180 | Authentication proxy |
| Demo-App | demo | 8000 | Main application backend |
| **OPA Policy Engine** | opa-system | 8181 | Policy Decision Point (AuthZ) |
| **SPIRE Server** | spire | 8081 | Workload Identity Provider |
| Prometheus | monitoring | 30090 | Metrics collection |
| Grafana | monitoring | 30030 | Dashboards & visualization |
| Loki | monitoring | 3100 | Log aggregation |

### AWS (Cloud)

| Service | Location | Port | Description |
|---------|----------|------|-------------|
| WireGuard Gateway | Public Subnet | 51820 | VPN endpoint |
| TKB-Service | K3s Worker | 30080 | Thời Khóa Biểu microservice |

---

## 🆕 OPA Policy Engine (Open Policy Agent)

### Chức năng
OPA là **Policy Decision Point (PDP)** - điểm ra quyết định authorization trong Zero Trust.

### Kiến trúc OPA

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    OPA - POLICY AS CODE                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐            │
│   │   Request   │ ──►  │     OPA     │ ──►  │   ALLOW /   │            │
│   │   Context   │      │   Engine    │      │   DENY      │            │
│   └─────────────┘      └──────┬──────┘      └─────────────┘            │
│                               │                                         │
│   Input JSON:                 │ Evaluates against                       │
│   {                           │ Rego Policy                             │
│     "user": "gv1",            ▼                                         │
│     "role": "giangvien",   ┌─────────────────────────────────────────┐ │
│     "path": "/api/gv"      │ package zta.authz                       │ │
│   }                         │                                         │ │
│                             │ role_permissions := {                   │ │
│                             │   "giangvien": ["/api/giangvien", ...], │ │
│                             │   "sinhvien": ["/api/sinhvien", ...]    │ │
│                             │ }                                       │ │
│                             │                                         │ │
│                             │ default allow := false                  │ │
│                             │                                         │ │
│                             │ allow if { ... }                        │ │
│                             └─────────────────────────────────────────┘ │
│                                                                         │
│   OPA API Endpoint:                                                     │
│   POST /v1/data/zta/authz/allow                                        │
│                                                                         │
│   Response:                                                             │
│   {"result": true}  → ALLOW                                            │
│   {"result": false} → DENY                                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Ưu điểm của OPA trong Zero Trust

| Tính năng | Lợi ích |
|-----------|---------|
| **Policy-as-Code** | Version control, audit trail, review process |
| **Decoupled** | Tách biệt policy khỏi application code |
| **Default DENY** | Tuân thủ nguyên tắc Zero Trust |
| **Fine-grained** | RBAC/ABAC chi tiết đến từng API endpoint |
| **Real-time** | Quyết định authorization trong milliseconds |

---

## 🆕 SPIFFE/SPIRE Workload Identity

### Chức năng
SPIFFE/SPIRE cung cấp **Workload Identity** - định danh cho từng service/pod, không dựa vào network location.

### Kiến trúc SPIRE

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SPIFFE/SPIRE WORKLOAD IDENTITY                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Trust Domain: zta.local                                               │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                      SPIRE SERVER                                │  │
│   │                                                                  │  │
│   │   • Trust Domain Authority                                       │  │
│   │   • Issues SVIDs (SPIFFE Verifiable Identity Documents)         │  │
│   │   • Manages workload registration                                │  │
│   │   • CA TTL: 24h (short-lived certificates)                       │  │
│   │                                                                  │  │
│   └──────────────────────────┬──────────────────────────────────────┘  │
│                              │                                          │
│                              │ Issue certificates                       │
│                              ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                      SPIRE AGENT (DaemonSet)                     │  │
│   │                                                                  │  │
│   │   Runs on each node:                                             │  │
│   │   • master (OpenStack)                                          │  │
│   │   • worker (OpenStack)                                          │  │
│   │   • aws-worker-1 (AWS)                                          │  │
│   │                                                                  │  │
│   └──────────────────────────┬──────────────────────────────────────┘  │
│                              │                                          │
│                              │ Attest & Issue SVID                      │
│                              ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                      WORKLOADS (Pods)                            │  │
│   │                                                                  │  │
│   │   Each workload receives SPIFFE ID:                              │  │
│   │   spiffe://zta.local/ns/<namespace>/sa/<serviceaccount>         │  │
│   │                                                                  │  │
│   │   Examples:                                                      │  │
│   │   • spiffe://zta.local/ns/demo/sa/demo-app                      │  │
│   │   • spiffe://zta.local/ns/microservices/sa/tkb-service          │  │
│   │   • spiffe://zta.local/ns/demo/sa/keycloak                      │  │
│   │                                                                  │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   Integration with Istio:                                               │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │   Istio uses SPIFFE for mTLS certificates                       │  │
│   │                                                                  │  │
│   │   Certificate SAN (Subject Alternative Name):                    │  │
│   │   URI: spiffe://cluster.local/ns/demo/sa/demo-app               │  │
│   │                                                                  │  │
│   │   mTLS handshake verifies SPIFFE ID before allowing connection  │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Ưu điểm của SPIFFE/SPIRE trong Zero Trust

| Tính năng | Lợi ích |
|-----------|---------|
| **Cryptographic Identity** | Không dựa vào IP/network (Zero Trust) |
| **Short-lived Certificates** | Auto-rotation, giảm risk nếu bị compromise |
| **Cross-Platform** | Hoạt động trên cả OpenStack và AWS |
| **Attestation** | Xác minh workload trước khi cấp identity |
| **SPIFFE Standard** | Tương thích với Istio, Envoy, nhiều tools khác |

---

## 🔒 Security Features Demonstrated

### Demo Scripts Available

```bash
# Security Demo (on server)
/tmp/live-security-demo.sh

# Tests:
# 1. Unauthenticated access → Redirect to Keycloak
# 2. Header injection attack → Headers stripped
# 3. Fake JWT token → Rejected
# 4. Direct pod access bypass → Network policy blocked
```

### Grafana Dashboards

- **ZTA Overview**: `http://172.10.0.190:30030/d/zta-overview/`
- **Security Logs**: `http://172.10.0.190:30030/d/zta-security-logs/`

---

## 🌟 Key Takeaways

1. **Identity-Centric Security**: All access decisions based on verified identity (Keycloak + SPIFFE)
2. **Policy-as-Code (OPA)**: Authorization rules defined in Rego, version-controlled, auditable
3. **Workload Identity (SPIRE)**: Cryptographic identity for services, not network-based
4. **Micro-Segmentation**: Services isolated by namespace, network policies, security groups
5. **Encrypted Communications**: WireGuard VPN + Istio mTLS with SPIFFE IDs = end-to-end encryption
6. **Continuous Verification**: Every request authenticated and authorized at multiple layers
7. **Unified Control Plane**: Single K3s cluster spans both clouds
8. **Centralized Monitoring**: Prometheus/Grafana/Loki for full observability
9. **Short-lived Credentials**: SPIRE certificates expire in 24h, automatic rotation
10. **Defense in Depth**: 7 layers of security controls

---

## 📚 Technology Stack

| Category | Technology |
|----------|------------|
| **Cloud Platforms** | OpenStack, AWS |
| **Container Orchestration** | K3s (Lightweight Kubernetes) |
| **Service Mesh** | Istio |
| **Identity Provider** | Keycloak |
| **Authentication Proxy** | OAuth2-Proxy |
| **Policy Engine** | Open Policy Agent (OPA) + Rego |
| **Workload Identity** | SPIFFE/SPIRE |
| **VPN** | WireGuard |
| **Monitoring** | Prometheus, Grafana, Loki |
| **IaC** | Terraform |
| **Languages** | Python (FastAPI), Node.js (Express) |

---

## 🎯 Zero Trust Maturity Model

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ZERO TRUST MATURITY ASSESSMENT                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   IDENTITY                                          ███████████ 95%    │
│   ├── Keycloak (OIDC/OAuth2)                       ✅                  │
│   ├── SPIFFE/SPIRE (Workload Identity)             ✅                  │
│   └── Short-lived certificates                     ✅                  │
│                                                                         │
│   DEVICES                                           ████████░░░ 80%    │
│   ├── Node attestation via SPIRE                   ✅                  │
│   └── Kubernetes pod security contexts             ✅                  │
│                                                                         │
│   NETWORK                                           ███████████ 95%    │
│   ├── WireGuard VPN (cross-cloud)                  ✅                  │
│   ├── Istio mTLS (service-to-service)              ✅                  │
│   └── Network Policies (microsegmentation)         ✅                  │
│                                                                         │
│   APPLICATION                                       ███████████ 95%    │
│   ├── OPA Policy Engine (AuthZ)                    ✅                  │
│   ├── OAuth2-Proxy (AuthN)                         ✅                  │
│   └── Role-based access control                    ✅                  │
│                                                                         │
│   DATA                                              ████████░░░ 80%    │
│   ├── Encryption in transit                        ✅                  │
│   └── Encryption at rest                           ⚠️ (partial)       │
│                                                                         │
│   VISIBILITY                                        ███████████ 95%    │
│   ├── Prometheus (metrics)                         ✅                  │
│   ├── Grafana (dashboards)                         ✅                  │
│   ├── Loki (logs)                                  ✅                  │
│   └── AWS VPC Flow Logs                            ✅                  │
│                                                                         │
│   AUTOMATION                                        ████████░░░ 85%    │
│   ├── Terraform (IaC)                              ✅                  │
│   ├── Kubernetes manifests                         ✅                  │
│   └── Auto certificate rotation (SPIRE)            ✅                  │
│                                                                         │
│   ═══════════════════════════════════════════════════════════════════  │
│   OVERALL ZERO TRUST MATURITY:                      ████████░░ 89%     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```
